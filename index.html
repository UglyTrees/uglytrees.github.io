<html>

	<!--
	
	MIT License

	Copyright (c) 2019 UglyTrees

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.

	-->

	<head>
		<title>UglyTrees</title>
		
		<meta charset="UTF-8">
		<meta name="description" content="A browser-based multispecies coalescent tree visualiser">
		<meta name="keywords" content="phylogenetics,bayesian,multispecies,coalescent,tree,uglytrees,javascript,svg">
		<meta name="author" content="Jordan Douglas">
		<meta name="viewport" content="width=1200">
		
		<link rel="icon" href="images/uglytreeslogo.png">
		<link rel="stylesheet" href="src/styles.css">

		
	<script type="text/x-mathjax-config">
	  MathJax.Hub.Config({
	    tex2jax: {
	      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
	      processEscapes: true
	    }
	  });
	</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script language='JavaScript' type='text/JavaScript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script type="text/javascript" src="/lib/jsgif/LZWEncoder.js"></script>
		<script type="text/javascript" src="/lib/jsgif/NeuQuant.js"></script>
		<script type="text/javascript" src="/lib/jsgif/GIFEncoder.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/tree.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/treeparsing.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/treewriting.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/drawTrees.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/visualsettings.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/util.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/templating.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/speciesGeneMapper.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/recorder.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/velocity.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/dropzone.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/chroma.js-master/chroma.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/easypz.latest.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/XMLWriter/XMLWriter.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"> </script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>


		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106202043-2"></script>
		
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'UA-106202043-2');
		</script>


		<script>


		


			function init(){





				
				SVG_TOP_MARGIN = 20;
				SVG_BOTTOM_MARGIN = 10;
				SVG_UNDER_BOTTOM_MARGIN = 25;
				SVG_LEFT_MARGIN = 20;
	
				AXIS_MARGIN = 30;			
				SVG_RIGHT_MARGIN = 20;
				SPECIES_LEAVES = [];
				textLabelPadding = 5;
				SPECIES_TREE = null;
				GENE_TREES = [];
				MAX_TREE_HEIGHT = 0;
				MAX_TREE_WIDTH = 0;
				SPECIES_TREES_ALL = [];
				GENE_TREES_ALL = [];
				READY_TO_DRAW = false;
				MAX_TEXT_SIZE = 0;

				SVG_HEIGHT = 0;
				SVG_WIDTH = 0;
				GAP_BETWEEN_SUBTREES = 0;

				BIG_SESSION = false; // Are there many gene trees?

				var svg = $("#tree");
				svg.html("");
				svg.height(SVG_HEIGHT);
				svg.width(SVG_WIDTH);

				
				yScaler = 1;
				TREE_NUM = null;
				NTREES = 0;


				oldScaleX_fn = null;
				oldScaleY_fn = null;
				
				
				// Init other js pages
				initUtil();
				initTemplates();
				initRecorder();
				initVisualSettings();
				initMapper();
				

				$("#treeNum").val(0);
				resizable(document.getElementById("treeNum"));


				//$(".showAfterTreeUpload").hide(0);
				$(".bigSessionWarning").hide(0);
				$(".showOnSpeciesAnnotationSelect").hide(0);
				$(".speciesAnnotationDiscrete").hide(0);
				$(".speciesAnnotationNumerical").hide(0);
				$("#currentGeneTreeNameContainer").hide(0);
				$(".displayOnRender").hide(0);

				$("#hoverAnnotationDiv").draggable();



				initRecorder("recordBtn", "stopRecordBtn", "cancelRecordBtn", "recorderProgress");

				



			}




			function stop() {
				START_PLAYING = false;
			}


			function play(callback = function() { }, progress = function() { }){

				if (START_PLAYING || NTREES == 0) return;

				$("#stopBtn").show(100);
				$("#playBtn").hide(0);

				START_PLAYING = true;
				CURRENT_ANIMATION_TIME = PLAY_TIME;
				play_recursive();

			}


			function play_recursive(){


				if (isPageHidden()) START_PLAYING = false;
				if (!START_PLAYING) {
					CURRENT_ANIMATION_TIME = ANIMATION_TIME;
					$("#playBtn").show(100);
					$("#stopBtn").hide(0);
					return;
				}
				console.log("play_recursive");


				// Keep incrementing until the species and gene trees have all changed
				var speciesNewickOld = Write.newick(SPECIES_TREE);

				TREE_NUM ++;
				while (false && TREE_NUM < NTREES){

					SPECIES_TREE = SPECIES_TREES_ALL[TREE_NUM];
					var speciesNewickNew = Write.newick(SPECIES_TREE);

					if (speciesNewickOld != speciesNewickNew) break;
					TREE_NUM ++;

				}

				if (TREE_NUM >= NTREES-1 || TREE_NUM < 0) TREE_NUM = 0;

				

				
				var animate = resetZoom();
				planTrees();
				renderTrees(null, animate, function() { 
					setTimeout(function() { play_recursive(); }, 50);
				 });

				//$("#trees").velocity("{}", {complete: function() {

					//alert("FINISH");
					// play_recursive();

					//setTimeout(function() { play_recursive(); }, 50);
				//}});

				//
				



			}


			function nextTree(skip = false, callback = function() { }, progress = function() { }) {
				stop();
				if (skip) {
					var skipBy = Math.round(roundToSF(NTREES / 20, 0));
					if (skipBy < 1) {
						nextTree();
						return;
					}
					TREE_NUM += skipBy;
					TREE_NUM = Math.min(TREE_NUM, NTREES-1);
				}
				else {
					if (TREE_NUM >= NTREES-1) TREE_NUM = 0;
					else TREE_NUM++;
				}
				
				var animate = resetZoom();
				planTrees();

				
				renderTrees(null, animate, callback, progress);

			}


			
			function prevTree(skip = false, callback = function() { }, progress = function() { }) {
				stop();
				if (skip) {
					var skipBy = Math.round(roundToSF(NTREES / 20, 0));
					if (skipBy < 1) {
						prevTree();
						return;
					}
					TREE_NUM -= skipBy;
					TREE_NUM = Math.max(TREE_NUM, 0);
				}
				else {
					if (TREE_NUM <= 0) TREE_NUM = NTREES - 1;
					else TREE_NUM--;
				}
				
				var animate = resetZoom();
				planTrees();
				renderTrees(null, animate, callback, progress);

			}


			function prevGeneTree() {

				if (GENE_TREES == null || GENE_TREES.length < 2) return;

				CURRENT_GENE_TREE_DISPLAY --;
				CURRENT_GENE_TREE_DISPLAY = CURRENT_GENE_TREE_DISPLAY % GENE_TREES.length;
				if (CURRENT_GENE_TREE_DISPLAY < 0) CURRENT_GENE_TREE_DISPLAY = GENE_TREES.length - 1;
				while (GENE_TREES[CURRENT_GENE_TREE_DISPLAY] == null) {
					CURRENT_GENE_TREE_DISPLAY --;
					CURRENT_GENE_TREE_DISPLAY = CURRENT_GENE_TREE_DISPLAY % GENE_TREES.length;
					if (CURRENT_GENE_TREE_DISPLAY < 0) CURRENT_GENE_TREE_DISPLAY = GENE_TREES.length - 1;
				}
				
				

				useJustOneGeneTree();


			}



			function nextGeneTree() {

				if (!READY_TO_DRAW) return;
				if (GENE_TREES == null || GENE_TREES.length < 2) return;


				CURRENT_GENE_TREE_DISPLAY ++;
				CURRENT_GENE_TREE_DISPLAY = CURRENT_GENE_TREE_DISPLAY % GENE_TREES.length;
				if (CURRENT_GENE_TREE_DISPLAY < 0) CURRENT_GENE_TREE_DISPLAY = GENE_TREES.length - 1;
				while (GENE_TREES[CURRENT_GENE_TREE_DISPLAY] == null) {


					CURRENT_GENE_TREE_DISPLAY ++;
					CURRENT_GENE_TREE_DISPLAY = CURRENT_GENE_TREE_DISPLAY % GENE_TREES.length;
					if (CURRENT_GENE_TREE_DISPLAY < 0) CURRENT_GENE_TREE_DISPLAY = GENE_TREES.length - 1;
				}


				useJustOneGeneTree();


			}


			function setTree(callback = function() { }, progress = function() { }){

				stop();
				var newVal = parseFloat($("#treeNum").val());
				if (TREE_NUM == newVal) return;
				TREE_NUM = newVal;
				if (TREE_NUM < 0) TREE_NUM = 0;
				if (TREE_NUM >= NTREES) TREE_NUM = NTREES-1;

				var animate = resetZoom();
				planTrees();
				renderTrees(null, animate);

			}




			
			
	

			// Don't redraw the tree until the user has stopped resizing for a period of time
			var resizeId;
			$(window).resize(function() {
				stop();
				$("#tree").html("");
				unhover();
				closeDialogs();
				resetZoom();
				clearTimeout(resizeId);
				resizeId = setTimeout(doneResizing, 100);
			});

			function doneResizing(){
				//planTrees();
			    renderTrees();
			}

			
			function userSaysDraw(){



				// Check mapping
				if (NUMBER_OF_GENE_TREES == 0) {
					UNMAPPED_GENE_LABELS = [];
				}
				if (UNMAPPED_GENE_LABELS.length > 0) {
					openMapperDialog(); 
					return;
				}

				if (READY_TO_DRAW) return;
				
				if (SPECIES_TREES_ALL.length == 0 || !SPECIES_TREES_ALL[0].successfullyMapped) return;

				READY_TO_DRAW = true;
				addLoaderDark($("#renderLoader"));
				$("#exampleSessions").hide(0);




				// Decide whether to show all the trees or just a subset
				BIG_SESSION = GENE_TREES_ALL.length > 10;
				if (!SESSION_FROM_TEMPLATE) {
					
					if (BIG_SESSION) {
						$(".bigSessionWarning").show(0);
						$("#bigSessionWarningFlasher").fadeIn(1000).delay(5000).fadeOut();
						useJustOneGeneTree();
					}
					else {
						$(".bigSessionWarning").hide(0);
						$("#bigSessionWarningFlasher").hide(0);
						useGeneTreeList();
					}


				}

				// Asynchronous to enable loader to be added first
				setTimeout(function(){
					planTrees();
					renderTrees();
				}, 10);

				
			}




			// Plans the species and gene trees but does not draw them
			function planTrees(){
			
				if (SPECIES_TREES_ALL.length == 0 || !READY_TO_DRAW) return;
			
			
				if (TREE_NUM < 0) TREE_NUM = 0;
				if (TREE_NUM >= SPECIES_TREES_ALL.length) TREE_NUM = SPECIES_TREES_ALL.length - 1;

			
				// Get the gene trees
				GENE_TREES = [];
				for (var g = 0;  g < GENE_TREES_ALL.length; g ++){
					if (GENE_TREES_ALL[g] == null) GENE_TREES.push(null);
					else GENE_TREES.push(GENE_TREES_ALL[g][TREE_NUM]);
				}


				oldScaleX_fn = SPECIES_TREE == null ? null : SPECIES_TREE.scaleX_fn;
				oldScaleY_fn = SPECIES_TREE == null ? null : SPECIES_TREE.scaleY_fn;


				// Get the species tree and its leaves
				SPECIES_TREE = SPECIES_TREES_ALL[TREE_NUM];


				// Get min and maxes of all annotations


				var allTreesToRender = [SPECIES_TREE];
				for (var g = 0; g < GENE_TREES.length; g++){
					if (gene_tree == null) continue;
					if (!toRenderGeneTree(g)) continue;
					allTreesToRender.push(GENE_TREES[g]);
				}
				getAnnotationMinAndMax(allTreesToRender);



	
				SPECIES_TREE.geneNodeMap = {};
				//console.log("speciesTree", SPECIES_TREE);
				var newSpeciesTreeAnnotations = getTreeAnnotations(SPECIES_TREE, true);
				renderAnnotations(newSpeciesTreeAnnotations);
				SPECIES_TREE.linewidth_fn = planLineWidths(SPECIES_TREE, SPECIES_BRANCH_MULTIPLIER, SPECIES_BRANCH_WIDTH);
				SPECIES_TREE.bgcolour_fn = planColour(SPECIES_TREE, SPECIES_BRANCH_BGCOL_ANNOTATION, SPECIES_TREE_BG_COL);
				SPECIES_TREE.bordercolour_fn = planColour(SPECIES_TREE, SPECIES_BRANCH_BORDER_ANNOTATION, SPECIES_TREE_BORDER_COL);


				console.log("SPECIES_BRANCH_BGCOL_ANNOTATION", SPECIES_BRANCH_BGCOL_ANNOTATION, SPECIES_TREE.bgcolour_fn);
				
				


				var totalNAtLeaves = 0;
				SPECIES_LEAVES = [];
				for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
				
					var node = SPECIES_TREE.nodeList[i];
					node.populationsizeTop = node.annotation[SPECIES_WIDTH_ANNOTATION_TOP] == null ? 1 : parseFloat(node.annotation[SPECIES_WIDTH_ANNOTATION_TOP]);
					node.populationsizeBottom = node.annotation[SPECIES_WIDTH_ANNOTATION_BOTTOM] == null ? (node.children.length == 0 ? 1 : 2) : parseFloat(node.annotation[SPECIES_WIDTH_ANNOTATION_BOTTOM]);
					node.coords = { bottomLeft: {x: -1, y: -1}, bottomRight: {x: -1, y: -1}, topLeft: {x: -1, y: -1}, topRight: {x: -1, y: -1}, dashed: {left: -1, right: -1}, xrange: {left: -1, right: -1}, xrangeTop: {left: -1, right: -1}, xrangeBottom: {left: -1, right: -1} };


					node.coordsStored = JSON.parse(JSON.stringify(node.coords));
					node.branchToGeneNodeMap = []; // Maps species branch to gene nodes
					node.nodeToGeneBranchMap = []; // Maps species nodes to gene branches
					
					for (var g = 0; g < GENE_TREES.length; g++){
						node.branchToGeneNodeMap[g] = {};
						node.nodeToGeneBranchMap[g] = {};
					}

					//console.log(i, SPECIES_TREE.nodeList[i].populationsize);
					
					//if (node.children.length == 0) {
					if (node.label != null) {	
						totalNAtLeaves += node.populationsizeBottom;
						SPECIES_LEAVES.push(node);
					}
				}



				SPECIES_TREE.successfullyMapped = applyTheMapping(SPECIES_LEAVES, GENE_TREES);
				if (!SPECIES_TREE.successfullyMapped){
					uploadNewFiles();
					return;
				}

				console.log("mapped", SPECIES_TREE);


				$("#fileUploading").hide(0);
				$(".showAfterTreeUpload").show(0);
				
				
				unhover();
				$(".dialog").remove();


			

				$("#treeNum").val(TREE_NUM);
				resizeInput($("#treeNum"));





				var tallestTreeHeight =  SPECIES_TREE.root.height;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					if (GENE_TREES[g] == null) continue;
					if (!toRenderGeneTree(g)) continue;
					var geneTreeHeight = GENE_TREES[g].root.height;
					if (GENE_TREES[g].root.branchLength != null && GENE_TREES[g].root.branchLength > 0) geneTreeHeight += GENE_TREES[g].root.branchLength;
					tallestTreeHeight = Math.max(tallestTreeHeight, geneTreeHeight);
				}
				var effectiveMaxHeight;






				// Get max tree height 
				switch (Y_RANGE) {
					case "treemax": {
						MAX_TREE_HEIGHT = tallestTreeHeight == SPECIES_TREE.root.height ? tallestTreeHeight * 1.05 : tallestTreeHeight;
						effectiveMaxHeight = MAX_TREE_HEIGHT;
						break;
					}

					case "globalmax": {

						break;
					}

					case "input": {
						MAX_TREE_HEIGHT = parseFloat($("#Y_RANGE_INPUT").val());
						effectiveMaxHeight = tallestTreeHeight * 1.05;
						break;
					}

					default: {
						MAX_TREE_HEIGHT = tallestTreeHeight;
						effectiveMaxHeight = tallestTreeHeight == SPECIES_TREE.root.height ? tallestTreeHeight * 1.05 : tallestTreeHeight;
					}

				}




				
				switch (X_RANGE) {
					case "treemax": {
						MAX_TREE_WIDTH = null;
						break;
					}

					case "globalmax": {

						break;
					}

					case "input": {
						MAX_TREE_WIDTH = parseFloat($("#X_RANGE_INPUT").val());
						break;
					}

					default: {
						MAX_TREE_WIDTH = null;
					}

				}


				
				
				GAP_BETWEEN_SUBTREES = SUBTREE_SPACER * totalNAtLeaves / SPECIES_LEAVES.length;
				
				planSpeciesTree(SPECIES_TREE.root, effectiveMaxHeight, SPECIES_WIDTH_ANNOTATION_TOP != "_none" && SPECIES_WIDTH_ANNOTATION_BOTTOM != "_none" && SPECIES_WIDTH_ANNOTATION_TOP != SPECIES_WIDTH_ANNOTATION_BOTTOM);
				if (SHOW_Y_AXIS) Y_AXIS = planAxis("time", 0, MAX_TREE_HEIGHT); // Math.max(MAX_TREE_HEIGHT, effectiveMaxHeight));	
				else Y_AXIS = null;

				console.log(effectiveMaxHeight, MAX_TREE_HEIGHT, "SHOW_Y_AXIS", Y_AXIS);
				
				if (SHOW_X_AXIS) X_AXIS = planAxis("pop", SPECIES_TREE.root.coords.xrange.left, MAX_TREE_WIDTH == null ? SPECIES_TREE.root.coords.xrange.right : MAX_TREE_WIDTH) ; //Math.max(SPECIES_TREE.root.coords.xrange.right, (MAX_TREE_WIDTH == null ? 0 : MAX_TREE_WIDTH)));	
				else X_AXIS = null;


				// Get the maximum pixel length of a species label
				MAX_TEXT_SIZE = getMaximumLabelTextSizeOfTree(SPECIES_TREE.root, SPECIES_LABEL_FONT_SIZE / ZOOM_SCALE, SPECIES_TIP_LABEL);


				



				//console.log("maxTextSize", MAX_TEXT_SIZE);

				//console.log("SPECIES_TREE", SPECIES_TREE);
			
			
				// Count number of displayed gene trees
				var numToDisplay = 0;
				for (var g = 0; g < GENE_TREES.length; g++){
					if (GENE_TREES[g] == null) continue;
					if (toRenderGeneTree(g)) numToDisplay++;
				}
			
			
				// Add gene tree offsets so that nodes don't overlap
				var numVisibleTreesCumulative = 0;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					if (GENE_TREES[g] == null) continue;
					if (toRenderGeneTree(g)) {
						GENE_TREES[g].offsetIndex = numVisibleTreesCumulative;
						numVisibleTreesCumulative++;
					}
					GENE_TREES[g].offsetTotal = numToDisplay;
				}
			
			
			
			
				// Plan the gene tree
				for (var g = 0; g < GENE_TREES.length; g++){

					var gene_tree = GENE_TREES[g];
					if (gene_tree == null) continue;
					
					// Check whether this is to be rendered
					if (!toRenderGeneTree(g)) continue;
					
		
					// Reset nodes
					for (var i = 0; i < gene_tree.nodeList.length; i ++) {
						var geneNode = gene_tree.nodeList[i];
						geneNode.coords = { cx: -1, cy: -1, x: [], y: [], strokeWidths: [] };
						geneNode.coordsStored = JSON.parse(JSON.stringify(geneNode.coords));
					}


					buildGeneTreeSpeciesTreeMap(g, gene_tree.root);
					planGeneTree(g, gene_tree.root, gene_tree, GROUP_GENES_BY_TAXA);


					var newGeneTreeAnnotations = getTreeAnnotations(gene_tree, false);
					renderAnnotations(newGeneTreeAnnotations);
					gene_tree.linewidth_fn = planLineWidths(gene_tree, GENE_BRANCH_MULTIPLIER, GENE_BRANCH_WIDTH, true, false);
					gene_tree.noderadius_fn = planLineWidths(gene_tree, GENE_NODE_MULTIPLIER, GENE_NODE_SIZE, true, true, GENE_ROOT_SIZE);
					gene_tree.bgcolour_fn = planColour(gene_tree, GENE_BRANCH_BGCOL_ANNOTATION, getGeneTreeColour(g), true);
			

					//console.log("newGeneTreeAnnotations", newGeneTreeAnnotations);
					MAX_TEXT_SIZE = Math.max(MAX_TEXT_SIZE, getMaximumLabelTextSizeOfTree(gene_tree.root, GENE_LABEL_FONT_SIZE / ZOOM_SCALE, GENE_TIP_LABEL));
					
					

				}


			}
			

			
			function getEmptySvg(css = false){
	

				return (!css ? "" : `
					<defs>
						<style type="text/css">
						   @import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro');
						</style>
					</defs>`) + `
					<g id="axisGroup" class="svgG"></g>
					<g id="speciesGroup" class="svgG"></g>
					<g id="geneGroup" class="svgG"></g>
					<g id="textGroup" class="svgG"></g>
					<g id="legendGroup" class="svgG"></g>`;

			}


			function renderTrees(options = null, animate = false, callback = function() { }, progress = function() { }) {


				if (SPECIES_TREES_ALL.length == 0 || !READY_TO_DRAW || !SPECIES_TREE.successfullyMapped) return;



				

				unhover();
				var svg;
				if (options == null) {

					svg = $("#tree");


					
					if (BIG_SESSION && !ONLY_ONE_GENE_TREE) animate = false;

					if (!animate) {
						svg.html(getEmptySvg());
						svg.height(0);
						svg.width(0);


						SVG_HEIGHT = parseFloat($("body").height()) - parseFloat($("#header").height()) - parseFloat($("#footer").height()) - SVG_UNDER_BOTTOM_MARGIN;
						SVG_WIDTH = parseFloat($("#main").width());


						svg.height(SVG_HEIGHT);
						svg.width(SVG_WIDTH);
						$(".displayOnRender").show(0);

						addLoader("#tree", id = "svgloader");

					}
					
				
				}else{
					svg = $(options.svgSelector);
					svg.html(getEmptySvg(true));
					svg.height(options.height);
					svg.width(options.width);

				}

				
				console.log("SVG_HEIGHT", SVG_HEIGHT, "SVG_WIDTH", SVG_WIDTH, $("#main"));
	

				var ymax = MAX_TREE_HEIGHT;
				var xmax = MAX_TREE_WIDTH;
				scaleTreeRanges(SPECIES_TREE, SVG_LEFT_MARGIN + AXIS_MARGIN , svg.height()-SVG_BOTTOM_MARGIN-GENE_NODE_SIZE-AXIS_MARGIN-MAX_TEXT_SIZE, svg.width()-SVG_RIGHT_MARGIN-AXIS_MARGIN , SVG_TOP_MARGIN+AXIS_MARGIN, xmax, ymax);
				
				
				

				var axisGroup = svg.find("#axisGroup");
				var speciesGroup = svg.find("#speciesGroup");
				var geneGroup = svg.find("#geneGroup");
				var textGroup = svg.find("#textGroup");
				var legendGroup = svg.find("#legendGroup");

				

				// Legends
				for (var treeAnnotNum = 0; treeAnnotNum < TREE_ANNOTATIONS.length; treeAnnotNum ++){
					var annotation = TREE_ANNOTATIONS[treeAnnotNum];
					legendGroup.find(`[annotation="` + annotation.name + `"]`).remove();

					if (annotation.legend.showLegend) {
						drawLegend(svg, legendGroup, annotation, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn);
					}

				}


				if (!animate) drawAxis(svg, axisGroup, X_AXIS, 1, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_TOP_MARGIN);
				else animateAxis(svg, axisGroup, X_AXIS, 1, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, oldScaleX_fn, oldScaleY_fn, SVG_TOP_MARGIN, CURRENT_ANIMATION_TIME);
				
				if (!animate) drawAxis(svg, axisGroup, Y_AXIS, 4, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_LEFT_MARGIN);
				else animateAxis(svg, axisGroup, Y_AXIS, 4, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, oldScaleX_fn, oldScaleY_fn, SVG_LEFT_MARGIN, CURRENT_ANIMATION_TIME);


				// Flag all svgs in the species/gene tree tree
				if (animate) {
					speciesGroup.find(".specieshoverbranch").addClass("flagged");
					geneGroup.find(".genenode").addClass("flagged");
					geneGroup.find(".genebranch").addClass("flagged");
					textGroup.find(".labelText").addClass("flagged");
				}
				

				
				// Draw the gene trees
				for (var g = 0; g < GENE_TREES.length; g++){

					var gene_tree = GENE_TREES[g];
					if (gene_tree == null) continue;
					//gene_tree.speciesNodeMap = {};
					
					
					// Do not render if unchecked
					if (!toRenderGeneTree(g)) {
						$(`[gNum="` + g + `"]`).fadeOut(CURRENT_FADE_TIME, function() { $(this).remove(); });
						continue;
					}
					

					if (!animate || $(`[gNum="` + g + `"]`).length == 0) drawAGeneTree(geneGroup, textGroup, gene_tree, "gene" + g, gene_tree.root, SPECIES_TREE, g, ZOOM_SCALE, function() { });
					else animateAGeneTree(geneGroup, textGroup, gene_tree, "gene" + g, gene_tree.root, SPECIES_TREE, g, CURRENT_ANIMATION_TIME, ZOOM_SCALE, function() { });

					
				}


				// Draw the species tree
				if (!animate) drawASpeciesTree(speciesGroup, textGroup, SPECIES_TREE, "speciestree", SPECIES_TREE.root, callback, progress);
				else {

					// Animate
					animateASpeciesTree(speciesGroup, textGroup, SPECIES_TREE, "speciestree", SPECIES_TREE.root, CURRENT_ANIMATION_TIME, callback, progress);

				}
				
				
				// Remove everything still flagged
				if (animate) {
					speciesGroup.find(".specieshoverbranch.flagged").remove();
					geneGroup.find(".genenode.flagged").remove();
					geneGroup.find(".genebranch.flagged").remove();
					textGroup.find(".labelText.flagged").remove();
				}


				$("#renderLoader").html("");

				//callback();

			}



			function addAnnoyingFlashMessage(msg) {

				$("body").append(`<div class="annoyingFlash">` + msg + `</div>`);


				$(".annoyingFlash").animate({
					fontSize: "200em",
					color: "yellow"
			    	}, 2000);

				setTimeout(function() {
					$(".annoyingFlash").remove();
				}, 2000);

			}
			






			function drawSVGobj(svg, type, attr, val = null, isNode = false, addBackground = false){

				//console.log("attr", attr);
				var newObj = document.createElementNS('http://www.w3.org/2000/svg', type);


	

				for (var a in attr){
					if (a == "text_anchor") newObj.setAttribute("text-anchor", attr[a]);
					else if (a == "alignment_baseline") newObj.setAttribute("alignment-baseline", attr[a]);
					else if (a == "stroke_dasharray") newObj.setAttribute("stroke-dasharray", attr[a]);
					else newObj.setAttribute(a, attr[a]);
				}
				if (val != null) newObj.innerHTML = val;
				newObj.setAttribute("animatable", "true");


				// Set some of the styles as attributes because safari and IE do not like styles for svgs
				var styles = getComputedStyle(newObj);
				//if (styles.fill != null) newObj.setAttribute("fill", styles.fill);
				if (styles.stroke != null) newObj.setAttribute("stroke", styles.stroke);
				if (styles["stroke-width"] != null) newObj.setAttribute("stroke-width", styles["stroke-width"]);
				//console.log(styles["stroke-width"]);

				//window.requestAnimationFrame(function() {
				svg.append(newObj);
				$(newObj).hide().fadeIn(CURRENT_FADE_TIME);	
				if (isNode && attr.id != null){
					$(newObj).contextmenu(function(e) {
						 openNodeMenu(attr.id, e) 
						 return false;
					});


					if (type != "polygon") {
						$(newObj).mousemove(function(e) {
							 hoverNode(attr.id, e) 
							 return false;
						});
					}


				}

				if (isNode) $(newObj).addClass("node");

			
				//});

				
				
				
				return newObj;

			}	



			function makeItGlow(ele, remainingFlashes = 3){

				if (remainingFlashes <= 0) return;


				ele.addClass("glowing");

				
				setTimeout(function() { 
					ele.removeClass("glowing");
					setTimeout(function() { 
						makeItGlow(ele, remainingFlashes-1);
					}, 300);
				}, 300);

			}


			function highlightNode(id){
			
				//console.log("highlighting", id);
				$("#" + id).attr("fill", "#008cba");
				$("#" + id).attr("opacity", "0.5");

			}


			// Opens the menu of a node
			function openNodeMenu(id, event){

				if (DONT_HOVER) return;
				$(".svg-selected").removeClass("svg-selected");

				var treeName = id.split("_")[0];
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);

				// Get the node
				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}
				if (node == null) return;


		


				// Can flip subtree if node has children (and if it is a species tree)
				$("#flipSubtreeBtn").unbind("click");
				if (node.children.length == 2 && treeName == "speciestree") {
					$("#flipSubtreeBtn").show(0);
 					$("#flipSubtreeBtn").click(function() { 
						unhover();
						flipSubtree(node); 
					});
				} 
				else $("#flipSubtreeBtn").hide(0);


				// Annotations
				$(".annotationRow").remove();
				for (var a in node.annotation){
					var val = node.annotation[a];
					var roundedVal = val; // roundToSF(val, 3);
					if (!isNaN(roundedVal)) val = roundedVal;
					$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>` + a + `: ` + val + `</td></tr>`);
				}



				// Branch length, time, label
				var branchLength = 0;
				if (node.parent != null) branchLength = roundToSF(node.parent.height - node.height, 4);
				else if (node.branchLength != null) branchLength = roundToSF(node.branchLength, 4);
				else if (node.parent == null && treeName == "speciestree" && MAX_TREE_HEIGHT > node.height) branchLength = roundToSF(MAX_TREE_HEIGHT - node.height, 4);
				
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Branch length: ` + branchLength + `</td></tr>`);
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Time: ` + roundToSF(node.height, 4) + `</td></tr>`);
				if (node.label != null) $("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Label: ` + node.label + `</td></tr>`);


				// Tree name
				var filename = treeName == "speciestree" ? SPECIES_UPLOADED_FILE.filename : GENE_UPLOADED_FILES[parseFloat(treeName.split("gene")[1])].filename;
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td><i>` + filename + `</i></td></tr>`);



				// Hover over incident branches if gene tree
				if (treeName != "speciestree"){
					$("#" + node.htmlID).addClass("svg-selected");
					$(`[branchfornode="` + node.htmlID + `"]`).addClass("svg-selected");
					if (node.children.length != 0) {
						$(`[branchfornode="` + node.children[0].htmlID + `"]`).addClass("svg-selected");
						$(`[branchfornode="` + node.children[1].htmlID + `"]`).addClass("svg-selected");
					}
					
					
				}else{
					//$("#" + node.htmlID + "_P").addClass("svg-selected");
				}



				var x = event.pageX;
				var y = event.pageY;
				
				
				// If mouse on bottom half of tree, add the .top class and set bottom to mouse
				var topPointer = y < parseFloat($("#innerBody").height()) / 2;
				var leftPointer = x < parseFloat($("#innerBody").width()) / 2;
				$("#hoverAnnotationDiv").removeClass("topLeftPointer");
				$("#hoverAnnotationDiv").removeClass("topRightPointer");
				$("#hoverAnnotationDiv").removeClass("bottomLeftPointer");
				$("#hoverAnnotationDiv").removeClass("bottomRightPointer");
				if (topPointer && leftPointer) {
					$("#hoverAnnotationDiv").addClass("topLeftPointer");
					$("#hoverAnnotationDiv").animate({top: y + "px", left: x + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
				}
				else if (!topPointer && leftPointer){
					$("#hoverAnnotationDiv").addClass("bottomLeftPointer");
					var topY = y - parseFloat($("#hoverAnnotationDiv").height());
					$("#hoverAnnotationDiv").animate({top: topY + "px", left: x + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
				}
				else if (topPointer && !leftPointer){
					$("#hoverAnnotationDiv").addClass("topRightPointer");
					var rightX = x - parseFloat($("#hoverAnnotationDiv").width()) - 5;
					//var topY = y - parseFloat($("#hoverAnnotationDiv").height());
					$("#hoverAnnotationDiv").animate({top: y + "px", left: rightX + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
				}
				else if (!topPointer && !leftPointer){
					$("#hoverAnnotationDiv").addClass("bottomRightPointer");
					var rightX = x - parseFloat($("#hoverAnnotationDiv").width()) - 5;
					var topY = y - parseFloat($("#hoverAnnotationDiv").height());
					$("#hoverAnnotationDiv").animate({top: topY + "px", left: rightX + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
				}
				
				$("#hoverAnnotationDiv").show(0);



			}


			// Alters the css of a node
			function hoverNode(id, event){

				if (DONT_HOVER) return;
				$(".svg-selected").removeClass("svg-selected");

				var treeName = id.split("_")[0];
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);

				// Get the node
				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}
				if (node == null) return;


				// Hover over incident branches if gene tree
				if (treeName != "speciestree"){
					$("#" + node.htmlID).addClass("svg-selected");
					$(`[branchfornode="` + node.htmlID + `"]`).addClass("svg-selected");
					if (node.children.length != 0) {
						$(`[branchfornode="` + node.children[0].htmlID + `"]`).addClass("svg-selected");
						$(`[branchfornode="` + node.children[1].htmlID + `"]`).addClass("svg-selected");
					}
					
					
				}else{
					//$("#" + node.htmlID + "_P").addClass("svg-selected");
				}



			}

			function unhover(){

				$("#hoverAnnotationDiv").hide(0);

				$("path.node").attr("fill", SPECIES_TREE_BG_COL);
				$(".svg-selected").removeClass("svg-selected");
				$(".node").attr("opacity", "1");
				$(".currentNodeInfo").html("");

				
			}




						
			window.onkeyup = function(e) {


				if ($("textarea").is(':focus') || $("input").is(':focus')) return;

				var key = e.keyCode ? e.keyCode : e.which;

				if (key == 39) { // Right arrow
					if (e.ctrlKey) {
						flashArrow("doublerightarrow");	
						nextTree(true); // Ctrl + right = last tree
					}
					else {
						flashArrow("rightarrow");		
						nextTree();
					}
				}
				
				else if (key == 37) { // Left arrow
					if (e.ctrlKey) {
						flashArrow("doubleleftarrow");	
						prevTree(true); // Ctrl + left = first tree
					}
					else {
						flashArrow("leftarrow");
						prevTree();
					}
				}

				else if (key == 40) { // Down arrow
					flashArrow("downarrow");
					nextGeneTree();
				}


				else if (key == 38) { // Up arrow
					flashArrow("uparrow");
					prevGeneTree();
				}
				
				else if (key == 27){ // Escape
					closeDialogs();
				}


			   
			}


			function flashArrow(id) {

				$("#" + id).addClass("flashing");
				setTimeout(function() {
					$("#" + id).removeClass("flashing");
				}, 150);

			}





			function loadFileAsString(url, resolve = function(result) { }){
			    
				console.log("Trying to open", url);
				var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});
						var str = xhttp.responseText;
						resolve(str);

					}
				}
				xhttp.open("GET", url, true);
			    	xhttp.send();

			}



		
			// Loads a .csv file and returns as an object
			function loadCSV(url, resolve = function(result) { }){
			    
			    console.log("Trying to open", url);
			    var xhttp = new XMLHttpRequest();
			    xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
				  
				    if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});

				    //console.log("xhttp.responseText", xhttp.responseText);
				    var csvString = xhttp.responseText.split("\n");
						if (csvString.length == 0)  return resolve( {error: "Error: empty csv file detected at " + url} );
						
						
						var CSV_obj = {};
						var column_names = [];
						
						
						// Parse the file
						var haveParsedHeader = false;
						var nrows = 0;
						for (var i = 0; i < csvString.length; i ++){
							var line = csvString[i].trim();
							if (line == "") continue;
							
							var splitLine = line.split("\t");
							
							
							
							
							var rowIsHeader = false;
							for (var j = 0; j < splitLine.length; j ++){
							
								// Parse the header
								if (!haveParsedHeader){
									rowIsHeader = true;
									
									column_names.push(splitLine[j]);
									CSV_obj[splitLine[j]] = [];
									
									

								
								} else {
								
									var value = splitLine[j];
									var colName = column_names[j];
									if (colName == null)  return resolve( {error: "Error: too many columns in row " + i + " of file " + url} );
									
									CSV_obj[colName].push(value);
									
									
								
								}
								
							}
							
							if (rowIsHeader) haveParsedHeader = true;
							else nrows ++;
						
						
						}
				    

						CSV_obj.nrows = nrows;
						return resolve(CSV_obj);

				   
				}
			    };
			    xhttp.open("GET", url, true);
			    xhttp.send();
			    
			    
			}




			function roundToSF(val, sf=2, ceilOrFloor = "none", precise = true){
				
				var magnitude = Math.floor(log(val, 10));

				if (val < 0 && ceilOrFloor == "ceil") ceilOrFloor = "floor";
				else if (val < 0 && ceilOrFloor == "floor") ceilOrFloor = "ceil";

				var num = val * tenToThePowerOf(sf-magnitude, precise);
				if (ceilOrFloor == "ceil") num = Math.ceil(num)
				else if (ceilOrFloor == "floor") num = Math.floor(num)
				else num = Math.round(num);

				num = num * tenToThePowerOf(magnitude-sf, precise);
				
				// Sometimes this picks up a trailing .00000000001 which we want to remove

				var expectedStringLength = 0;
				if (magnitude >= 0) expectedStringLength = magnitude >= sf ? magnitude+1 : sf+2; // Add 1 for the decimal point
				else expectedStringLength = 2 -magnitude + sf;
				if (num < 0) expectedStringLength++; // Also need the negative symbol



				num = parseFloat(num.toString().substring(0, expectedStringLength+1));
				
				return num;
					
			}




			// Compute 10^n without using Math.pow for negative n which presents numerical instabilities
			function tenToThePowerOf(n, precise = true){

				if (!precise) return Math.pow(10, n);

				if (n == Infinity || n == -Infinity) return n;

				if (n == 0) return 1;
				var val = "1";
				if (n < 0) {
				
				
					for (var index = -1; index > n; index --){
						val = "0" + val;
					}
					val = "." + val;
				}

				else if (n > 0) {
					return Math.pow(10, n);

				}
				else {
					return 1;
				}
				//console.log(n, "->", parseFloat(val));
				return parseFloat(val);


			}


			function log(num, base = null){
				
				if (num == 0) return 0;
				if (base == null) return Math.log(Math.abs(num));
				return Math.log(Math.abs(num)) / Math.log(base);
				
				
			}


			// https://codepen.io/rgfx/pen/qxyGyy
			function resizable (el) {
				function resize() {el.style.width = ((el.value.length+5) * 0.5) + "em"};
				var e = 'keyup,keypress,focus,blur,change'.split(',');
				for (var i in e) el.addEventListener(e[i],resize,false);
				resize();
			}


			function resizeInput(ele){
				var int = 0.5;
				$(ele).width( (($(ele).val().length + 1) * 0.5) + "em" );
			}
			




		</script>

	</head>
	<body  onload="init()">



		<div id="measureText"></div>

		
		<div id="hoverAnnotationDiv" style="display:none">

			<div>
				<table cellpadding="5" style="font-size:85%">
					<tr id="hoverAnnotationTitle">
						<td><b>Node information</b></td>
					</tr>

					<tr id="flipSubtreeBtn" class="rowbutton" title="Swap the two children of this node">
						<td>Flip subtree</td>
					</tr>

					<tr  class="rowbutton" title="Close annotation box" onclick="unhover()">
						<td>Close</td>
					</tr>
				</table>
			</div>

		</div>

		<div id="viewNav" class="sidenav" style="width:0px;">	
		
			<div class="sideNavHeader">
				View 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>


			<hr>
			
			
			<div class="sideNavSetting" title="Zoom in on font?">
				
				<div><b> Enlarge font on zoom </b></div>
				<span style="font-size:100%; vertical-align:middle">No</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="ZOOM_ON_FONT" OnChange="setVisualParams();"> </input>
						 <span class="switchslider"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Yes</span>	<br><br>

				<div class="paramHelper">
					Zooming is performed with the mousewheel. If this box is checked, fonts will remain the same size upon zooming.
				</div>



			</div>



			<hr>
			
			
			<div class="sideNavSetting" style="font-size:80%">
			
				<label class="checkbox-container">
					<input type="checkbox" id="SHOW_X_AXIS" checked="checked" name="radio" onchange="setVisualParams();">
					<span class="checkmark"></span> Show x-axis
				</label>

				
				<div style="font-size:120%; text-align:left"> X-axis max:</div><br>
				 <div style="font-size:80%; margin-left:4em">
					
					<label class="checkbox-container" for="treemaxX">
						<input type="radio" id="treemaxX" name="X_RANGE" value="treemax"  onchange="setVisualParams();">
						<span class="checkmark"></span> Tree max
					</label>
					
				<!--
					<label class="checkbox-container" for="globalmaxX">
						<input type="radio" id="globalmaxX" name="X_RANGE" value="globalmax"  onchange="setVisualParams();">
						<span class="checkmark"></span>Global max
					</label>
				-->

					<label class="checkbox-container" for="inputX">
						<input type="radio" id="inputX" name="X_RANGE" value="input"  onchange="setVisualParams();">
						<span class="checkmark"></span>Input:
					</label>
					<input type="number" step="0.1" class="numberinput cranberry" onclick="$(this).select()" id="X_RANGE_INPUT" style="width:5em;" value="1.0" onchange="setVisualParams();">
					

				</div>
				



			</div>



			
			<hr>



			<div class="sideNavSetting" style="font-size:80%; text-size-adjust:120%;">
				
				<label class="checkbox-container">
					<input type="checkbox" id="SHOW_Y_AXIS" checked="checked" name="radio" onchange="setVisualParams();">
					<span class="checkmark"></span> Show y-axis
				</label>


				
				<div style="font-size:120%; text-align:left"> Y-axis max:</div><br>
				 <div style="font-size:80%; margin-left:4em">
					
					<label class="checkbox-container" for="treemaxY">
						<input type="radio" id="treemaxY" name="Y_RANGE" value="treemax"  onchange="setVisualParams();">
						<span class="checkmark"></span> Tree max
					</label>
					
				<!--
					<label class="checkbox-container" for="globalmaxY">
						<input type="radio" id="globalmaxY" name="Y_RANGE" value="globalmax"  onchange="setVisualParams();">
						<span class="checkmark"></span>Global max
					</label>
				-->

					<label class="checkbox-container" for="inputY">
						<input type="radio" id="inputY" name="Y_RANGE" value="input"  onchange="setVisualParams();">
						<span class="checkmark"></span>Input:
					</label>
					<input type="number" step="0.1" class="numberinput cranberry" onclick="$(this).select()" id="Y_RANGE_INPUT" style="width:5em;" value="1.0" onchange="setVisualParams();">
					

				</div>
				



			</div>
			<hr>


			<div class="sideNavSetting" title="Specify annotation properties">
				Node annotations<br><br>
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown geneAnnotationsDropdown" id="MODEL_ANNOTATIONS_SPECIES" onchange="selectSpeciesAnnotationSettings();" title="Species tree annotation settings">

				</select>
				
				<div id="speciesAnnotationsMissingDataWarning" style="display:none; font-size:70%">
					Warning: missing values. Some nodes are not annotated with this annotation.
				</div>

			</div>
			
			
			<div class="sideNavSetting showOnSpeciesAnnotationSelect">
				<div><b> Data type </b></div>
				<span style="font-size:100%; vertical-align:middle">Numerical</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="speciesAnnotationDiscreteChk" OnChange="setAnnotationDataType();"> </input>
						 <span id="speciesAnnotationDiscreteSpan" class="switchslider notboolean"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Discrete</span>	
			</div>


			<div class="sideNavSetting speciesAnnotationNumerical"  style="font-size:60%">
				<label class="checkbox-container">
					<input type="checkbox" id="showLegendBtn" onclick="toggleLegend();" name="radio" onchange="setVisualParams();">
					<span class="checkmark"></span> Show legend
				</label>

				<div style="font-size:120%">
					Drag a legend to move it.
				</div>
			</div>



	
			<div class="sideNavSetting speciesAnnotationNumerical">
				<table style="width:100%;">
					<tr id="speciesTreeAnnotationColGradient" class="colourGradientRow">
					</tr>
				</table>
				<span id="speciesAnnotationMinVal" style="font-size:70%; float:left;">Min</span>
				<span id="speciesAnnotationMaxVal" style="font-size:70%; float:right;">Max</span>
			</div>
			
			
			<table class="colourSetting speciesAnnotationNumerical">
				<tr id="speciesTreeAnnotationMinCol" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxSpeciesMin" class="colourbox" title="Select colour" onclick='openColourPicker("speciesTreeAnnotationMinCol");' style="background-color:white"></span>
					</td>
					
					<td>
						Palette min
					</td>
				</tr>
			</table>
			
			
			<table class="colourSetting  speciesAnnotationNumerical">
				<tr id="speciesTreeAnnotationMaxCol" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxSpeciesMax" class="colourbox" title="Select colour" onclick='openColourPicker("speciesTreeAnnotationMaxCol");' style="background-color:white"></span>
					</td>
					
					<td>
						Palette max
					</td>
				</tr>
			</table>
			
			
			<div class="sideNavSetting speciesAnnotationNumerical">
				Number of colours: <input type="number" min=1 max=100 step=1 id="speciesAnnotationNumCols" class="numberinput cranberry" onclick="$(this).select()" onchange="updateSpeciesAnnotationPalette(); setVisualParams();" style="width:5em">
			</div>
			
			
			<table id="speciesAnnotationDiscreteTable" class="colourSetting speciesAnnotationDiscrete">

			</table>
			
			
			
			<hr>

			<br><br><br>
			

		</div>

	
			
		<div id="speciesTreeSideNav" class="sidenav" style="width:0px;">

			<div class="sideNavHeader">
				Species tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>
			
			<hr>
			

			
			<div class="sideNavSetting" id="speciesOpacityDiv">
				<input id="SPECIES_TREE_OPACITY" class="slider" onchange="setVisualParams();" type="range" min="0" max="100" value="0" step="1">
				Opacity (<span></span>%)
			</div>
			
			<hr>


			<div class="sideNavSetting">
				<input id="SPECIES_LABEL_FONT_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="60" value="0" step="0.5">
				Label font size (<span></span> px)
			</div>
			
			
			<div class="sideNavSetting" title="Species tree tip node labels">
				Tip labels
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown" id="SPECIES_TIP_LABEL" onchange="setVisualParams();" title="Tree annotation to print on leaf nodes.">
		
				</select>

			</div>


			<div class="sideNavSetting" title="Attempt to express tip labels in latin binomial form (by splitting into separate words and italicising)?">
				
				<span style="font-size:100%; vertical-align:middle">Latin binomial tips</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="LATIN_BINOMIAL_SPECIES_TREE" OnChange="setVisualParams();"> </input>
						 <span class="switchslider"></span>
					</label> 
				
		
				</select>

			</div>
			
			
			<div class="sideNavSetting" title="Species tree internal node labels">
				Internal node labels
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown" id="SPECIES_INTERNAL_LABEL" onchange="setVisualParams();" title="Tree annotation to print on internal nodes.">

						
				</select>

			</div>
			
			<div class="sideNavSetting" title="Number of significant figures to round numeric text labels to">
				Round numbers to
				<input type="number" step="1" min="1" class="numberinput cranberry" onclick="$(this).select()" id="LABEL_ROUNDING_SF" style="width:5em;" value="1" onchange="setVisualParams();"> sf
			</div>
			


			<hr>
			





			<div class="sideNavSetting" title="Species tree x axis">
				Species node width top
				<select class="dropdown speciesAnnotationsDropdown numericalOnly" id="SPECIES_WIDTH_ANNOTATION_TOP" onchange="setVisualParams();" title="Tree annotation to describe node width by at the top of each branch">
						
						
				</select>

			</div>


			<div class="sideNavSetting" title="Species tree x axis">
				Species node width bottom
				<select class="dropdown speciesAnnotationsDropdown numericalOnly" id="SPECIES_WIDTH_ANNOTATION_BOTTOM" onchange="setVisualParams();" title="Tree annotation to describe node width by at the bottom of each branch. If this term is not set, then it will be the same as the top width.">
						
						
				</select>

			</div>
			
			<div class="sideNavSetting">
				<input id="SUBTREE_SPACER" class="slider" onchange="setVisualParams();" type="range" min="0" max="3" value="0" step="0.05">
				Horizontal spacing (<span></span>)
			</div>

		
			
			

			<hr>
			
			<div class="sideNavSetting" title="Species tree line width">
				Line width multiplier
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown numericalOnly" id="SPECIES_BRANCH_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to multiply species tree branch width baseline by">
						
				</select>
			</div>
			
			
			<div class="sideNavSetting">
				<input id="SPECIES_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Line width baseline (<span></span> px)
			</div>

			<hr>
			
						

			<div class="sideNavSetting" title="Species tree line width">
				Colour branch border by
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown" id="SPECIES_BRANCH_BORDER_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branch borders by">
						
						
				</select>

			</div>
			
			
			<table class="colourSetting">
				<tr id="speciesBorder" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBorder" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBorder");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch border colour
					</td>
				</tr>
			</table>
			
			
			<hr>

			
			<div class="sideNavSetting" title="Species tree line width">
				Colour branch background by
				<select class="dropdown dropdownWithLabel speciesAnnotationsDropdown" id="SPECIES_BRANCH_BGCOL_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branch backgrounds by">

				</select>

			</div>
			
			<table class="colourSetting">
				<tr id="speciesBG" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBG" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBG");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch background colour
					</td>
				</tr>
			</table>
			
			

			<hr>

			<br><br><br>


		</div>
		
		


		<div id="geneTreeSideNav" class="sidenav" style="width:0px;">	
		
			<div class="sideNavHeader">
				Gene tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>

			<hr>





			
			<div class="sideNavSetting" id="geneOpacityDiv">
				<input id="GENE_TREE_OPACITY" class="slider" onchange="setVisualParams();" type="range" min="0" max="100" value="0" step="1">
				Opacity (<span></span>%)
			</div>
			<hr>



			<div class="sideNavSetting">
				<input id="GENE_LABEL_FONT_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="60" value="0" step="0.5">
				Label font size (<span></span> px)
			</div>




			<div class="sideNavSetting" title="Gene tree tip node labels">
				Tip labels
				<select class="dropdown dropdownWithLabel geneAnnotationsDropdown" id="GENE_TIP_LABEL" onchange="setVisualParams();" title="Tree annotation to print on leaf nodes.">
		
				</select>

			</div>



			<div class="sideNavSetting" title="Attempt to express tip labels in latin binomial form (by splitting into separate words and italicising)?">
				
				<span style="font-size:100%; vertical-align:middle">Latin binomial tips</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="LATIN_BINOMIAL_GENE_TREE" onChange="setVisualParams();"> </input>
						 <span class="switchslider"></span>
					</label> 

				</select>

			</div>

			<hr>

			
			<div class="sideNavSetting" title="Group gene tree nodes by genes or taxa">
				<div><b> Group gene trees by </b></div>
				<span style="font-size:100%; vertical-align:middle">Genes</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="GROUP_GENES_BY_TAXA" OnChange="setVisualParams();"> </input>
						 <span class="switchslider notboolean"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Taxa</span>	
				
			</div>
			
			
			
			<hr>


			<div class="sideNavSetting" title="Gene tree node sizes">
				Node radius multiplier
				<select class="dropdown dropdownWithLabel geneAnnotationsDropdown numericalOnly" id="GENE_NODE_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to describe gene node radius by">
				</select>

			</div>




			<div class="sideNavSetting">
				<input id="GENE_ROOT_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Root node radius baseline (<span></span> px)
			</div>



			<div class="sideNavSetting">
				<input id="GENE_NODE_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Node radius baseline (<span></span> px)
			</div>
			<hr>
			



			<div class="sideNavSetting" title="Gene tree line widths">
				Line width multiplier
				<select class="dropdown dropdownWithLabel geneAnnotationsDropdown numericalOnly" id="GENE_BRANCH_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to describe branch line width by">

						
				</select>

			</div>

			<div class="sideNavSetting">
				<input id="GENE_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="5" value="0" step="0.05">
				 Line width baseline (<span></span> px)
			</div>
			<hr>


			<div class="sideNavSetting" title="Species tree line width">
				Colour branches by
				<select class="dropdown dropdownWithLabel geneAnnotationsDropdown" id="GENE_BRANCH_BGCOL_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branches by">

				</select>

			</div>
			
			<table id="geneTreeColours"  class="colourSetting">
			
			</table>


			<hr>

			<br><br><br>
			
		</div>
		
		

		<div id="innerBody">


			<div id="header">

				
			
					<ul class="flex-container thicklines" style="font-size:20%;">
				
						<li class="flex-item" style="width:30%">
						
							<div class="topbuttondiv">
						
								<div class="textbutton left showAfterTreeUpload" onclick="uploadNewFiles()" title="Upload additional files">Open</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openDownloadDialog()" title="Download">Save As</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('viewNav')" title="Configure general visual settings">View</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('speciesTreeSideNav')" title="Configure species trees settings">Species tree</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('geneTreeSideNav')" title="Configure gene trees settings">Gene trees</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openMapperDialog()" title="Configure the mapping between gene and species leaves">Map</div>
								
								
								
							</div>
						
						</li>
						
						<li class="flex-item mainheader">
							UglyTrees
							<div class="subheader">A multispecies coalescent visualiser </div>	
						</li>
						
						
						<li class="flex-item" style="width:30%">
							<div class="topbuttondiv">
								<div class="textbutton right" title="Tutorials and guides"><a href="about/">About</a></div>
								<div class="textbutton right selected" title="Use UglyTrees"><a href="../">UglyTrees</a></div>
								
							</div>
						</li>
						

					</ul>
				
				
			</div>



			<div id="main">

				<table id="fileUploading" cellspacing=10>
					<tr>
						<td class="uploaderTd">
							<div id="species_tree_upload" class="uploader">
								<div>Upload a species tree file</div>
								<table id="speciesTreeUploadTable"">
								</table>
								
							</div>
						</td>

						<td style="text-align:center" colspan=2>
							
							<div id="template_upload" class="uploader small">
								<div>Upload a template (optional)</div>
								<table id="sessionUploadTable"">
								</table>
							</div>

							<br><br>
							<span id="renderTreesBtn" onclick="userSaysDraw();" class="button large disabled">Draw trees</span> <br><br>
							<span id="renderLoader"> </span>

						</td>

						<td  class="uploaderTd">
							<div id="gene_tree_upload" class="uploader">
								<div>Upload one or more gene tree files (optional)</div>
								<table id="geneTreeUploadTable">
								</table>
							</div>
						</td>
					</tr>
					
					
				</table>		
				<div id="treeDIV">
					<svg id="tree" height=0 width=0 ></svg>
				</div>

			</div>



			<div id="exampleSessions">
							

					<br><b>OR</b> select an example session <br>

					<ul class="flex-container thicklines">
				
						<li class="flex-item" style="width:30%; max-width:300px; padding: 1em">
						
							<div class="exampleDiv">
						
								<b>Gophers:</b> a multispecies coalescent model consisting of 8 species, 27 taxa, and 3 gene trees, using the Gopher data from Belfiore et al. 2008. There are 361 species/gene tree samples from the posterior distribution.<br><br>

								<div style="text-align:center">

									<a style="text-decoration:none" href="http://www.uglytrees.nz/?w=http://uglytrees.nz/examples/gopher/session.xml"><span class="button">Launch</span></a>

									<a style="text-decoration:none" href="https://github.com/UglyTrees/uglytrees.github.io/tree/master/examples/gopher"><span class="button">View files</span></a>
								</div> <br>

								<div class="exampleRef">
									Belfiore, N. M., Liu, L., and Moritz, C. (2008). Multilocus phylogenetics of a rapid radiation in the genus thomomys (rodentia: Geomyidae). Systematic Biology, 57(2), 294310.
								</div>

							</div>
						
						</li>


						<li class="flex-item" style="width:30%; max-width:300px; padding: 1em">
						
							<div class="exampleDiv">
						
								<b>Simulated:</b> a moderate sized test session simulated using BEAST2. This multispecies coalescent model consists of 20 species, 60 taxa, and 100 gene trees. <br><br>

								<div style="text-align:center">

									<a style="text-decoration:none" href="http://www.uglytrees.nz/?w=http://uglytrees.nz/examples/simulated/session.xml"><span class="button">Launch</span></a>

									<a style="text-decoration:none" href="https://github.com/UglyTrees/uglytrees.github.io/tree/master/examples/simulated"><span class="button">View files</span></a>
								</div> <br>

								<div class="exampleRef">
									Bouckaert, Remco, et al. "BEAST 2.5: An advanced software platform for Bayesian evolutionary analysis." PLoS computational biology 15.4 (2019): e1006650.
								</div>

							</div>
						
						</li>


					</ul>

				
			</div>


			<div id="bigSessionWarningFlasher" >
				A large number of gene trees have been detected. Use the up/down arrows below to cycle through gene trees. Open the 'Gene trees' top menu for advanced options.
			</div>


			<div id="footer" >



				<table style="text-align:center; width: 100%; margin:auto" >
					
					<tr>

						<td  style="width:40%; text-align:right">




							<span class="displayOnRender" style="float:left; text-align: left;  margin-left:1em">

								<div style="font-size:80%; text-shadow:none; color:white" >
									Right click on a node for more information <br>
									Use the mousewheel to zoom <br>
									Drag when zoomed to pan <br>
								</div>
							</span>


							

							
						</td>





						<td  style="width:20%"> 


							<table id="remoteTable" >


								<tr>
									<td>
									</td>

									<td style="text-align: center;">
										<div id="uparrow" title="Go to previous gene tree (Hotkey: &uarr;)" class="arrow" style="margin-bottom:0.4em" onclick="prevGeneTree()">&#x2038;</div> 
									</td>

									<td>
									</td>

								</tr>


								<tr>
									<td style="text-align: right;">
										<div>
											<span id="doubleleftarrow" title="Skip backwards several states (Hotkey:  ctrl + &larr;)" class="arrow" onclick="prevTree(true)">&#xab;</span> 
											<span id="leftarrow" title="Go to previous state (Hotkey: &larr;)" class="arrow" onclick="prevTree()">&#x2039;</span> 
										</div>

									</td>

									<td style="text-align: center;">
										<div >
											<span title="Play" id="playBtn" class="arrow" style="font-size:150%; margin-left:0.3em;" onclick="play()">&#9654;</span> 
											<span title="Stop" id="stopBtn" class="arrow" style="font-size:180%; margin-left:0.15em;  display:none" onclick="stop()">&#9632;</span> 
											
										</div>
									</td>

									<td style="text-align: left;">
										<div>
											<span id="rightarrow" title="Go to next state (Hotkey: &rarr;)" class="arrow" onclick="nextTree()">&#x203A;</span>
											<span id="doublerightarrow" title="Skip forward several states (Hotkey: ctrl + &rarr;)" class="arrow" onclick="nextTree(true)">&#xbb;</span> 
										</div>
									</td>

								</tr>

								<tr>
									<td>
									</td>

									<td style="text-align: center;">
										<div id="downarrow" title="Go to next gene tree (Hotkey: &darr;)" class="arrow rotate180" style="margin-top:0.45em" onclick="nextGeneTree()">&#x2038;</div> 
									</td>

									<td>
									</td>

								</tr>

							</table>


							
						</td>

						<td style="width:20%; text-align:left; font-size:80%" >



							<span title="Record the animation as a gif" id="recordBtn" class="arrow" style="font-size:200%; margin-left:0.3em;" onclick="startRecording()">&#x23FA;</span> 
							<span title="Stop recording" id="stopRecordBtn" class="arrow" style="display:none; font-size:200%; margin-left:0.3em;" onclick="stopRecording()">&#9209;</span> 
							<span title="Cancel recording" id="cancelRecordBtn" class="arrow" style="display:none; font-size:200%; margin-left:0.3em;" onclick="stopEncoding()">&cross;</span> 

							<span id="recorderProgress" style="display:none; font-size:150%;" class="whitefont">Preparing gif... <span></span> </span> <br>



						</td>


						<td style="width:20%; text-align:right; font-size:80%" >



							<span  title="The state number of the currently displayed set of trees  (corresponding to the left/right arrows)." id="treeNumContainer" class="whitefont">Sample number: <input class="numberinput cranberry" type="number" id="treeNum" style="width:2em; font-size:100%" onchange="setTree()"  value=0></input></span> <br>


							<span title="The name of the currently displayed gene tree  (corresponding to the up/down arrows). Gene tree displays can be further refined using the 'Gene trees' top menu. " id="currentGeneTreeNameContainer" class="whitefont" style="font-size:120%">
								Current gene tree: &nbsp;&nbsp; <span class="cranberry" id="currentGeneTreeName" style="width:2em; font-size:100%"></span> 

							</span>


						</td>


						

					
					</tr>

				</table>


				
		
			


				
			</div>

		</div>

	</body>




</html>
