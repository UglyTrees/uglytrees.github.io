<html>

	<!--
	
	MIT License

	Copyright (c) 2019 UglyTrees

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.

	-->

	<head>
		<title>UglyTrees</title>
		
		<meta charset="UTF-8">
		<meta name="description" content="A browser-based multispecies coalescent tree visualiser">
		<meta name="keywords" content="phylogenetics,bayesian,multispecies,coalescent,tree,uglytrees,javascript,svg">
		<meta name="author" content="Jordan Douglas">
		
		<link rel="icon" href="images/uglytreeslogo.png">
		<link rel="stylesheet" href="src/styles.css">

		
	<script type="text/x-mathjax-config">
	  MathJax.Hub.Config({
	    tex2jax: {
	      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
	      processEscapes: true
	    }
	  });
	</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script language='JavaScript' type='text/JavaScript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/tree.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/treeparsing.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/treewriting.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/drawTrees.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/visualsettings.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/util.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/speciesGeneMapper.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/velocity.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/dropzone.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/chroma.js-master/chroma.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/easypz.latest.js"></script>
		<script>


		


			function init(){


				
				SVG_TOP_MARGIN = 20;
				SVG_BOTTOM_MARGIN = 10;
				SVG_UNDER_BOTTOM_MARGIN = 25;
				SVG_LEFT_MARGIN = 20;
	
				AXIS_MARGIN = 20;			
				SVG_RIGHT_MARGIN = 20;
				SPECIES_LEAVES = [];
				textLabelPadding = 5;
				SPECIES_TREE = null;
				GENE_TREES = [];
				MAX_TREE_HEIGHT = 0;
				SPECIES_TREES_ALL = [];
				GENE_TREES_ALL = [];
				READY_TO_DRAW = false;
				MAX_TEXT_SIZE = 0;

				SVG_HEIGHT = 0;
				SVG_WIDTH = 0;
				GAP_BETWEEN_SUBTREES = 0;

				var svg = $("#tree");
				svg.html("");
				svg.height(SVG_HEIGHT);
				svg.width(SVG_WIDTH);

				
				yScaler = 1;
				BURNIN = 0.1;
				TREE_NUM = 0;
				NTREES = 0;
				
				
				
				initVisualSettings();
				initMapper();
				

				$("#treeNum").val(0);
				resizable(document.getElementById("treeNum"));
				//$(".showAfterTreeUpload").hide(0);
				$(".showOnSpeciesAnnotationSelect").hide(0);
				$(".speciesAnnotationDiscrete").hide(0);
				$(".speciesAnnotationNumerical").hide(0);
				
				


				// Operator
				SPECIES_TREE_X = null;
				ALPHA = 0; 		
				ALPHA_WINDOW = 0.003;
				$("#windowInput").val(ALPHA_WINDOW);
				revALPHA = 1;

				initUtil();


			}

			function updateAlphaWindow() {
				ALPHA_WINDOW = parseFloat($("#windowInput").val());
			}


			function stop() {
				START_PLAYING = false;
			}


			function play(){

				if (START_PLAYING || NTREES == 0) return;

				$("#stopBtn").show(100);
				$("#playBtn").hide(0);

				START_PLAYING = true;
				CURRENT_ANIMATION_TIME = PLAY_TIME;
				play_recursive();

			}


			function play_recursive(){


				if (isPageHidden()) START_PLAYING = false;
				if (!START_PLAYING) {
					CURRENT_ANIMATION_TIME = ANIMATION_TIME;
					$("#playBtn").show(100);
					$("#stopBtn").hide(0);
					return;
				}
				console.log("play_recursive");


				// Keep incrementing until the species and gene trees have all changed
				var speciesNewickOld = Write.newick(SPECIES_TREE);

				TREE_NUM ++;
				while (false && TREE_NUM < NTREES){

					SPECIES_TREE = SPECIES_TREES_ALL[TREE_NUM];
					var speciesNewickNew = Write.newick(SPECIES_TREE);

					if (speciesNewickOld != speciesNewickNew) break;
					TREE_NUM ++;

				}

				if (TREE_NUM >= NTREES-1 || TREE_NUM < 0) TREE_NUM = 0;

				
				
				planTrees();
				renderTrees(null, true);
				setTimeout(function() { play_recursive(); }, CURRENT_ANIMATION_TIME);
				



			}


			function nextTree(skip = false) {
				stop();
				if (skip) {
					var skipBy = Math.round(roundToSF(NTREES / 20, 0));
					if (skipBy < 1) {
						nextTree();
						return;
					}
					TREE_NUM += skipBy;
					TREE_NUM = Math.min(TREE_NUM, NTREES-1);
				}
				else {
					if (TREE_NUM >= NTREES-1) return;
					TREE_NUM++;
				}
				
				planTrees();
				renderTrees(null, true);

			}


			
			function prevTree(skip = false) {
				stop();
				if (skip) {
					var skipBy = Math.round(roundToSF(NTREES / 20, 0));
					if (skipBy < 1) {
						prevTree();
						return;
					}
					TREE_NUM -= skipBy;
					TREE_NUM = Math.max(TREE_NUM, 0);
				}
				else {
					if (TREE_NUM <= 0) return;
					TREE_NUM--;
				}
				
				planTrees();
				renderTrees(null, true);

			}



			function setTree(){

				stop();
				var newVal = parseFloat($("#treeNum").val());
				if (TREE_NUM == newVal) return;
				TREE_NUM = newVal;
				if (TREE_NUM < 0) TREE_NUM = 0;
				if (TREE_NUM >= NTREES) TREE_NUM = NTREES-1;
				planTrees();
				renderTrees(null, true);
			}


			
			
	

			// Don't redraw the tree until the user has stopped resizing for a period of time
			var resizeId;
			$(window).resize(function() {
				stop();
				$("#tree").html("");
				$("#hoverAnnotationDiv").hide(0);
				closeDialogs();
				clearTimeout(resizeId);
				resizeId = setTimeout(doneResizing, 100);
			});

			function doneResizing(){
				//planTrees();
			    renderTrees();
			}

			
			function userSaysDraw(){
				READY_TO_DRAW = true;
				planTrees();
				renderTrees();
			}




			// Plans the species and gene trees but does not draw them
			function planTrees(){
			
				if (SPECIES_TREES_ALL.length == 0 || !READY_TO_DRAW) return;
			
			
			
				// Get the gene trees
				GENE_TREES = [];
				for (var g = 0;  g < GENE_TREES_ALL.length; g ++){
					if (GENE_TREES_ALL[g] == null) GENE_TREES.push(null);
					else GENE_TREES.push(GENE_TREES_ALL[g][TREE_NUM]);
				}


				// Get the species tree and its leaves
				SPECIES_TREE = SPECIES_TREES_ALL[TREE_NUM];



	
				SPECIES_TREE.geneNodeMap = {};
				console.log("speciesTree", SPECIES_TREE);
				var newSpeciesTreeAnnotations = getTreeAnnotations(SPECIES_TREE, true);
				renderAnnotations(newSpeciesTreeAnnotations);
				SPECIES_TREE.linewidth_fn = planLineWidths(SPECIES_TREE, SPECIES_BRANCH_MULTIPLIER, SPECIES_BRANCH_WIDTH);
				SPECIES_TREE.bgcolour_fn = planColour(SPECIES_TREE, SPECIES_BRANCH_BGCOL_ANNOTATION, SPECIES_TREE_BG_COL);
				SPECIES_TREE.bordercolour_fn = planColour(SPECIES_TREE, SPECIES_BRANCH_BORDER_ANNOTATION, SPECIES_TREE_BORDER_COL);
				
				


				var totalNAtLeaves = 0;
				SPECIES_LEAVES = [];
				for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
				
					var node = SPECIES_TREE.nodeList[i];
					node.rate = node.annotation["branchRates.Species"] = null ? 1 : parseFloat(node.annotation["branchRates.Species"]);
					node.populationsize = node.annotation[SPECIES_WIDTH_ANNOTATION] == null ? 1 : parseFloat(node.annotation[SPECIES_WIDTH_ANNOTATION]);
					node.coords = { bottomLeft: {x: -1, y: -1}, bottomRight: {x: -1, y: -1}, topLeft: {x: -1, y: -1}, topRight: {x: -1, y: -1}, dashed: {left: -1, right: -1}, xrange: {left: -1, right: -1} };


					node.coordsStored = JSON.parse(JSON.stringify(node.coords));
					node.branchToGeneNodeMap = []; // Maps species branch to gene nodes
					node.nodeToGeneBranchMap = []; // Maps species nodes to gene branches
					
					for (var g = 0; g < GENE_TREES.length; g++){
						node.branchToGeneNodeMap[g] = {};
						node.nodeToGeneBranchMap[g] = {};
					}

					//console.log(i, SPECIES_TREE.nodeList[i].populationsize);
					
					//if (node.children.length == 0) {
					if (node.label != null) {	
						totalNAtLeaves += node.populationsize;
						SPECIES_LEAVES.push(node);
					}
				}



				SPECIES_TREE.successfullyMapped = mapAllGeneTreesToSpeciesTree(SPECIES_LEAVES, GENE_TREES);
				if (!SPECIES_TREE.successfullyMapped){
					return;
				}


				$("#fileUploading").hide(0);
				$(".showAfterTreeUpload").show(0);
				
				
				unhover();
				$(".dialog").remove();




			

				$("#treeNum").val(TREE_NUM);
				resizeInput($("#treeNum"));


				// Get max tree height 
				MAX_TREE_HEIGHT = SPECIES_TREE.root.height;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					if (GENE_TREES[g] == null) continue;
					MAX_TREE_HEIGHT = Math.max(MAX_TREE_HEIGHT, GENE_TREES[g].root.height);
				}
				//if (MAX_TREE_HEIGHT == SPECIES_TREE.root.height) MAX_TREE_HEIGHT *= 1.1;
				var effectiveMaxHeight = MAX_TREE_HEIGHT == SPECIES_TREE.root.height ? MAX_TREE_HEIGHT * 1.1 : MAX_TREE_HEIGHT;
				
				
				GAP_BETWEEN_SUBTREES = SUBTREE_SPACER * totalNAtLeaves / SPECIES_LEAVES.length;
				
				planSpeciesTree(SPECIES_TREE.root, effectiveMaxHeight);
				if (SHOW_Y_AXIS) Y_AXIS = planAxis("time", 0, effectiveMaxHeight);	
				else Y_AXIS = null;
				
				if (SHOW_X_AXIS) X_AXIS = planAxis("pop", SPECIES_TREE.root.coords.xrange.left, SPECIES_TREE.root.coords.xrange.right);	
				else X_AXIS = null;


				// Get the maximum pixel length of a species label
				MAX_TEXT_SIZE = getMaximumLabelTextSizeOfTree(SPECIES_TREE.root, SPECIES_LABEL_FONT_SIZE);
				console.log("maxTextSize", MAX_TEXT_SIZE);

				storeTree(SPECIES_TREE.root);
				console.log("SPECIES_TREE", SPECIES_TREE);
			
			
				// Count number of displayed gene trees
				var numToDisplay = 0;
				for (var g = 0; g < GENE_TREES.length; g++){
					if (GENE_TREES[g] == null) continue;
					if (GENE_TREE_DISPLAYS[g] == null || GENE_TREE_DISPLAYS[g] == true) numToDisplay++;
				}
			
			
				// Add gene tree offsets so that nodes don't overlap
				var numVisibleTreesCumulative = 0;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					if (GENE_TREES[g] == null) continue;
					if (GENE_TREE_DISPLAYS[g] == null || GENE_TREE_DISPLAYS[g] == true) {
						GENE_TREES[g].offsetIndex = numVisibleTreesCumulative;
						numVisibleTreesCumulative++;
					}
					GENE_TREES[g].offsetTotal = numToDisplay;
				}
			
			
			
			
				// Plan the gene tree
				for (var g = 0; g < GENE_TREES.length; g++){

					var gene_tree = GENE_TREES[g];
					if (gene_tree == null) continue;
					
					// Do not render if unchecked
					if (GENE_TREE_DISPLAYS[g] != null && GENE_TREE_DISPLAYS[g] == false) continue;
					
		
					// Reset nodes
					for (var i = 0; i < gene_tree.nodeList.length; i ++) {
						var geneNode = gene_tree.nodeList[i];
						geneNode.coords = { cx: -1, cy: -1, x: [], y: [], strokeWidths: [] };
						geneNode.coordsStored = JSON.parse(JSON.stringify(geneNode.coords));

					}


					buildGeneTreeSpeciesTreeMap(g, gene_tree.root);
					planGeneTree(g, gene_tree.root, gene_tree, GROUP_GENES_BY_TAXA);


					var newGeneTreeAnnotations = getTreeAnnotations(gene_tree, false);
					renderAnnotations(newGeneTreeAnnotations);
					gene_tree.linewidth_fn = planLineWidths(gene_tree, GENE_BRANCH_MULTIPLIER, GENE_BRANCH_WIDTH, true, false);
					gene_tree.noderadius_fn = planLineWidths(gene_tree, GENE_NODE_MULTIPLIER, GENE_NODE_SIZE, true, true);
					gene_tree.bgcolour_fn = planColour(gene_tree, GENE_BRANCH_BGCOL_ANNOTATION, getGeneTreeColour(g), true);
			

					console.log("newGeneTreeAnnotations", newGeneTreeAnnotations);
					

				}


			}
			

			
			function getEmptySvg(css = false){
	

				return (!css ? "" : `
					<defs>
						<style type="text/css">
						   @import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro');
						</style>
					</defs>`) + `
					<g id="axisGroup"></g>
					<g id="speciesGroup"></g>
					<g id="geneGroup"></g>
					<g id="textGroup"></g>`;

			}


			function renderTrees(options = null, animate = false) {


				if (SPECIES_TREES_ALL.length == 0 || !READY_TO_DRAW || !SPECIES_TREE.successfullyMapped) return;
				

				unhover();
				var svg;
				if (options == null) {

					svg = $("#tree");
					
					
					if (!animate) {
						svg.html(getEmptySvg());
						svg.height(0);
						svg.width(0);


						SVG_HEIGHT = parseFloat($("body").height()) - parseFloat($("#header").height()) - parseFloat($("#footer").height()) - SVG_UNDER_BOTTOM_MARGIN;
						SVG_WIDTH = parseFloat($("#main").width());
						

						svg.height(SVG_HEIGHT);
						svg.width(SVG_WIDTH);
					
					}
					
				
				}else{
					svg = $(options.svgSelector);
					svg.html(getEmptySvg(true));
					svg.height(options.height);
					svg.width(options.width);
				}


	
	
				scaleTreeRanges(SPECIES_TREE, SVG_LEFT_MARGIN + AXIS_MARGIN , svg.height()-SVG_BOTTOM_MARGIN-GENE_NODE_SIZE-AXIS_MARGIN-MAX_TEXT_SIZE, svg.width()-SVG_RIGHT_MARGIN-AXIS_MARGIN , SVG_TOP_MARGIN+AXIS_MARGIN );
				
			
				

				var axisGroup = svg.find("#axisGroup");
				var speciesGroup = svg.find("#speciesGroup");
				var geneGroup = svg.find("#geneGroup");
				var textGroup = svg.find("#textGroup");




				if (!animate) drawAxis(svg, axisGroup, X_AXIS, 1, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_TOP_MARGIN);
				else animateAxis(svg, axisGroup, X_AXIS, 1, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_TOP_MARGIN, CURRENT_ANIMATION_TIME);
				
				if (!animate) drawAxis(svg, axisGroup, Y_AXIS, 4, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_LEFT_MARGIN);
				else animateAxis(svg, axisGroup, Y_AXIS, 4, SPECIES_TREE.scaleX_fn, SPECIES_TREE.scaleY_fn, SVG_LEFT_MARGIN, CURRENT_ANIMATION_TIME);

				// Draw the species tree
				if (!animate) drawASpeciesTree(speciesGroup, textGroup, SPECIES_TREE, "speciestree", SPECIES_TREE.root);
				else animateASpeciesTree(speciesGroup, textGroup, SPECIES_TREE, "speciestree", SPECIES_TREE.root, CURRENT_ANIMATION_TIME);

				
				// Draw the gene tree
				for (var g = 0; g < GENE_TREES.length; g++){

					var gene_tree = GENE_TREES[g];
					if (gene_tree == null) continue;
					//gene_tree.speciesNodeMap = {};
					
					
					// Do not render if unchecked
					if (GENE_TREE_DISPLAYS[g] != null && GENE_TREE_DISPLAYS[g] == false) {
						$(`[gNum="` + g + `"]`).fadeOut(FADE_TIME, function() { $(this).remove(); });
						continue;
					}
					
					if (!animate || $(`[gNum="` + g + `"]`).length == 0) drawAGeneTree(geneGroup, gene_tree, "gene" + g, gene_tree.root, SPECIES_TREE, g);
					else animateAGeneTree(geneGroup, gene_tree, "gene" + g, gene_tree.root, SPECIES_TREE, g, CURRENT_ANIMATION_TIME);

					
				}


			}


			function operate(step = 1) {

				


				var desc = "";
				switch(step) {

					case 1: {
						restoreTree(SPECIES_TREE.root);
						if (SPECIES_TREE_X != null) moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
						$("#sampledAlpha").html("");
						desc = `Sample an internal node $x$ from the species tree $S$. Let $t_x$, $r_x$, and $N_x$ be its time, rate, and effective population size, respectively.`;
						//desc = `$x$`;
						break;
					}

					case 2: {
						desc = `Sample $\\alpha \\sim \\text{Uniform}(-w, w)$ for some window size $w$.`;
						break;
					}

					case 3: {
				
						desc = `Propose a new node time for $x$ as <br><br> $ {t_x}^\\prime \\leftarrow  t_x + \\alpha$ <br><br> Ensure that $\\max\\{t_{L}, t_{R} \\} < {t_x}^\\prime < t_{P}$. `;
						break;
					}
					case 4: {

						if (ALPHA != 0 && revALPHA == 1) moveSpeciesTreeNode(SPECIES_TREE_X, ALPHA)
						desc = `Propose new rates for the following species tree nodes: <br><br> 
							{r_x}^\prime &\leftarrow r_x \times  \frac{t_{P} - t_x}{t_{P} - {t_x}^\prime } \tag{$f_2$} <br> 
							{r_{L}}^\prime &\leftarrow r_{L} \times  \frac{t_x - t_{L}}{{t_x}^\prime - t_{L} } \tag{$f_3$} <br> 
							{r_{R}}^\prime &\leftarrow r_{R} \times  \frac{t_x - t_{R}}{{t_x}^\prime - t_{R} } \tag{$f_4$}`;
						break;
					}
					case 5: {
						desc = ``;
						break;
					}
					case 6: {
						desc = ``;
						break;
					}

					case 7: {
						desc = ``;
						break;
					}


				}


				$(".dialog").remove();
				$("body").append(getstepDialogTemplate(step, desc));
				//var math=MathJax.Hub.getAllJax("dialogDesc")[0];
				//MathJax.Hub.Queue(["Text",math,desc]); 

				

			}




			function doOperation(step = 1){


				// Move the template
				jQuery("#operatorDialog").detach().appendTo("#operatorPanel");
				$("#operatorDialog").addClass("toTheSide");
				$("#dialogBtn").html("Next");
				$("#dialogBtn").attr("onclick", "operate(" + (step + 1) + ")");

				$("#dialogBtnRev").hide(0);
				switch(step) {

					case 1: {
						
						// Sample a node
						var speciesTreeInternalNodes = [];
						for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
							if (SPECIES_TREE.nodeList[i].parent != null && SPECIES_TREE.nodeList[i].children.length == 2) {
								speciesTreeInternalNodes.push(SPECIES_TREE.nodeList[i]);
							}
						}
						SPECIES_TREE_X = speciesTreeInternalNodes[Math.floor(Math.random() * speciesTreeInternalNodes.length)];
						highlightNode(SPECIES_TREE_X.htmlID + "_P");
						break;
					}

					case 2: {

						// Sample alpha
						ALPHA = roundToSF(Math.random() * 2 * ALPHA_WINDOW - ALPHA_WINDOW);
						$("#sampledAlpha").html(ALPHA);

						makeItGlow($("#sampledAlpha").parent());

						break;
					}

					case 3: {

						revALPHA = -1;
						$("#dialogBtnRev").show(0);
						$("#dialogBtnRev").click(function() {
							if (revALPHA == -1) restoreTree(SPECIES_TREE_X, ALPHA * revALPHA);
							else restoreProposedTree(SPECIES_TREE_X, ALPHA * revALPHA);
							moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
							revALPHA *= -1;
						});


						//console.log(SPECIES_TREE_X, SPECIES_TREE_X.height, SPECIES_TREE_X.height + ALPHA, SPECIES_TREE_X.parent.height, SPECIES_TREE_X.children[0].height, SPECIES_TREE_X.children[1].height);

					


						var accepted = proposeMoveSpeciesTreeNode(SPECIES_TREE_X, ALPHA);
						
						if (!accepted) {
						
							// Reject
							addAnnoyingFlashMessage("Rejected");
							$("#dialogDesc").append(`<br><br><b>Proposal rejected. Try again.</b>`);
							$("#dialogBtn").hide(0);
							console.log("Reject");

						}
						
						moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);



						break;
					}
					case 4: {

						break;
					}
					case 5: {

						break;
					}
					case 6: {

						break;
					}

					case 7: {

						break;
					}

				}


			}



			function getstepDialogTemplate(stepNum, desc){
				return `
						<div id="operatorDialog" class="dialog">
							<div class="dialog_inner">
							<h2>Step ` + stepNum + `</h2>

								<div id="dialogDesc" style="font-size:120%">` + desc + `</div><br>
								
								
								<span id="dialogBtn" onclick=doOperation(` + stepNum + `) style="float:right" class="button">Do it</span>
								<span id="dialogBtnRev" style="display:none; float:right" class="button">Undo</span>
							</div>
						</div>

					`;

			}



			function addAnnoyingFlashMessage(msg) {

				$("body").append(`<div class="annoyingFlash">` + msg + `</div>`);


				$(".annoyingFlash").animate({
					fontSize: "200em",
					color: "yellow"
			    	}, 2000);

				setTimeout(function() {
					$(".annoyingFlash").remove();
				}, 2000);

			}
			






			function drawSVGobj(svg, type, attr, val = null, isNode = false, addBackground = false){

				//console.log("attr", attr);
				var newObj = document.createElementNS('http://www.w3.org/2000/svg', type);


	

				for (var a in attr){
					if (a == "text_anchor") newObj.setAttribute("text-anchor", attr[a]);
					else if (a == "alignment_baseline") newObj.setAttribute("alignment-baseline", attr[a]);
					else if (a == "stroke_dasharray") newObj.setAttribute("stroke-dasharray", attr[a]);
					else newObj.setAttribute(a, attr[a]);
				}
				if (val != null) newObj.innerHTML = val;



				// Set some of the styles as attributes because safari and IE do not like styles for svgs
				var styles = getComputedStyle(newObj);
				//if (styles.fill != null) newObj.setAttribute("fill", styles.fill);
				if (styles.stroke != null) newObj.setAttribute("stroke", styles.stroke);
				if (styles["stroke-width"] != null) newObj.setAttribute("stroke-width", styles["stroke-width"]);
				if (isNode) newObj.setAttribute("class", "node");
				//console.log(styles["stroke-width"]);

				svg.append(newObj);
				$(newObj).hide().fadeIn(FADE_TIME);

				
				if (isNode && attr.id != null){
					$("#" + attr.id).click(function(e) { hoverNode(attr.id, e) });
				}
				

				
				return newObj;

			}	



			function makeItGlow(ele, remainingFlashes = 3){

				if (remainingFlashes <= 0) return;


				ele.addClass("glowing");

				
				setTimeout(function() { 
					ele.removeClass("glowing");
					setTimeout(function() { 
						makeItGlow(ele, remainingFlashes-1);
					}, 300);
				}, 300);

			}


			function highlightNode(id){
			
				//console.log("highlighting", id);
				$("#" + id).attr("fill", "#008cba");
				$("#" + id).attr("opacity", "0.5");

			}


			function hoverNode(id, event){


				var treeName = id.split("_")[0];
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);

				// Get the node
				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}
				if (node == null) return;


				// Can flip subtree if node has children (and if it is a species tree)
				$("#flipSubtreeBtn").unbind("click");
				if (node.children.length == 2 && treeName == "speciestree") {
					$("#flipSubtreeBtn").show(0);
 					$("#flipSubtreeBtn").click(function() { 
						$('#hoverAnnotationDiv').hide(0);
						flipSubtree(node); 
					});
				} 
				else $("#flipSubtreeBtn").hide(0);


				// Annotations
				$(".annotationRow").remove();
				for (var a in node.annotation){
					var val = node.annotation[a];
					var roundedVal = roundToSF(val, 3);
					if (!isNaN(roundedVal)) val = roundedVal;
					$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>` + a + `: ` + val + `</td></tr>`);
				}



				// Branch length, time, label
				var branchLength = 0;
				if (node.parent != null) branchLength = roundToSF(node.parent.height - node.height, 3);
				else if (node.parent == null && treeName == "speciestree" && MAX_TREE_HEIGHT > node.height) branchLength = roundToSF(MAX_TREE_HEIGHT - node.height, 3);
				
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Branch length: ` + branchLength + `</td></tr>`);
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Time: ` + roundToSF(node.height, 3) + `</td></tr>`);
				if (node.label != null) $("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td>Label: ` + node.label + `</td></tr>`);


				// Tree name
				var filename = treeName == "speciestree" ? SPECIES_UPLOADED_FILE.filename : GENE_UPLOADED_FILES[parseFloat(treeName.split("gene")[1])].filename;
				$("#hoverAnnotationTitle").after(`<tr class="annotationRow"><td><i>` + filename + `</i></td></tr>`);
				


				var x = event.pageX;
				var y = event.pageY;
				console.log(x, y, treeName, node);
				
				
				// If mouse on bottom half of tree, add the .top class and set bottom to mouse
				var topPointer = y < parseFloat($("#innerBody").height()) / 2;
				if (topPointer) {
					$("#hoverAnnotationDiv").addClass("topPointer");
					$("#hoverAnnotationDiv").removeClass("bottomPointer");
					$("#hoverAnnotationDiv").animate({top: y + "px", left: x + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
				}else{
					$("#hoverAnnotationDiv").removeClass("topPointer");
					$("#hoverAnnotationDiv").addClass("bottomPointer");
					var topY = y - parseFloat($("#hoverAnnotationDiv").height());
					$("#hoverAnnotationDiv").animate({top: topY + "px", left: x + "px"}, $("#hoverAnnotationDiv").is(":hidden") ? 0 : 200);
					//console.log(x, y, topY, parseFloat($("#hoverAnnotationDiv").height()));
				}
				
				$("#hoverAnnotationDiv").show(0);


				
				
				/*
				unhover();

				

				if(SPECIES_TREE_X != null) highlightNode(SPECIES_TREE_X.htmlID + "_P");


				if($("#" + id).attr("name") == null) return;

				$("#currentNodeName").html("(" + $("#" + id).attr("name") + ")");


				//console.log("node.id", id);

				var treeName = id.split("_")[0];

			
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);





				if (treeName != "speciestree") {
					//$(`[branchfornode="` + id + `"].genebranch`).css("stroke", "#DB5079");
					//$(`[branchfornode="` + id + `"].genebranch`).css("stroke-width", "3px");
					$(`[branchfornode="` + id + `"].genebranch`).addClass("selected");
					
					
				}else {
					$("#" + id).attr("opacity", "0.5");
					$("#" + id).attr("fill", "#DB5079");
					
					// Get the node
					for (var s = 0; s < SPECIES_TREE.nodeList.length; s++){
						if (SPECIES_TREE.nodeList[s].id == nodeID){
							var node = SPECIES_TREE.nodeList[s];
							for (var g = 0; g < GENE_TREES.length; g++){
							
								console.log(g, GENE_TREES.length);
							
								for (var m in node.branchToGeneNodeMap[g]){
									$("#gene" + g + "_" + m).addClass("selected");
								}
								
								for (var m in node.nodeToGeneBranchMap[g]){
									$(`[branchfornode="gene` + g + `_` + m + `"].genebranch`).addClass("selected");
								}
								
							}
							
	
							
							break;
													
							
						}
					
					}
					
				}




				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}

				$("#currentNodeTime").html(roundToSF(node.height));
				$("#currentNodeRate").html(roundToSF(node.rate));
				$("#currentNodeSize").html(roundToSF(node.populationsize));
				if (node.parent != null){
					$("#currentNodeDistance").html(roundToSF(node.rate * (node.parent.height - node.height)));
				}else {
					$("#currentNodeDistance").html("NA");
				}


			*/

			}

			function unhover(){

				$("#hoverAnnotationDiv").hide(0);

				$("path.node").attr("fill", SPECIES_TREE_BG_COL);
				$("circle.node").removeClass("selected");
				$(".node").attr("opacity", "1");
				$(".genebranch").removeClass("selected");
				$(".currentNodeInfo").html("");

				
			}




						
			window.onkeyup = function(e) {


				if ($("textarea").is(':focus') || $("input").is(':focus')) return;

				var key = e.keyCode ? e.keyCode : e.which;

				if (key == 39) { // Right arrow
					if (e.ctrlKey) nextTree(true); // Ctrl + right = last tree
					else nextTree();
				
				
				}
				
				else if (key == 37) { // Left arrow
					if (e.ctrlKey) prevTree(true); // Ctrl + left = first tree
					else prevTree();
				
				}
				
				else if (key == 27){ // Escape
					closeDialogs();
				}


			   
			}





			function loadFileAsString(url, resolve = function(result) { }){
			    
				console.log("Trying to open", url);
				var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});
						var str = xhttp.responseText;
						resolve(str);

					}
				}
				xhttp.open("GET", url, true);
			    	xhttp.send();

			}



		
			// Loads a .csv file and returns as an object
			function loadCSV(url, resolve = function(result) { }){
			    
			    console.log("Trying to open", url);
			    var xhttp = new XMLHttpRequest();
			    xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
				  
				    if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});

				    //console.log("xhttp.responseText", xhttp.responseText);
				    var csvString = xhttp.responseText.split("\n");
						if (csvString.length == 0)  return resolve( {error: "Error: empty csv file detected at " + url} );
						
						
						var CSV_obj = {};
						var column_names = [];
						
						
						// Parse the file
						var haveParsedHeader = false;
						var nrows = 0;
						for (var i = 0; i < csvString.length; i ++){
							var line = csvString[i].trim();
							if (line == "") continue;
							
							var splitLine = line.split("\t");
							
							
							
							
							var rowIsHeader = false;
							for (var j = 0; j < splitLine.length; j ++){
							
								// Parse the header
								if (!haveParsedHeader){
									rowIsHeader = true;
									
									column_names.push(splitLine[j]);
									CSV_obj[splitLine[j]] = [];
									
									

								
								} else {
								
									var value = splitLine[j];
									var colName = column_names[j];
									if (colName == null)  return resolve( {error: "Error: too many columns in row " + i + " of file " + url} );
									
									CSV_obj[colName].push(value);
									
									
								
								}
								
							}
							
							if (rowIsHeader) haveParsedHeader = true;
							else nrows ++;
						
						
						}
				    

						CSV_obj.nrows = nrows;
						return resolve(CSV_obj);

				   
				}
			    };
			    xhttp.open("GET", url, true);
			    xhttp.send();
			    
			    
			}




			function roundToSF(val, sf=2, ceilOrFloor = "none", precise = true){
				
				var magnitude = Math.floor(log(val, 10));

				if (val < 0 && ceilOrFloor == "ceil") ceilOrFloor = "floor";
				else if (val < 0 && ceilOrFloor == "floor") ceilOrFloor = "ceil";

				var num = val * tenToThePowerOf(sf-magnitude, precise);
				if (ceilOrFloor == "ceil") num = Math.ceil(num)
				else if (ceilOrFloor == "floor") num = Math.floor(num)
				else num = Math.round(num);

				num = num * tenToThePowerOf(magnitude-sf, precise);
				
				// Sometimes this picks up a trailing .00000000001 which we want to remove

				var expectedStringLength = 0;
				if (magnitude >= 0) expectedStringLength = magnitude >= sf ? magnitude+1 : sf+2; // Add 1 for the decimal point
				else expectedStringLength = 2 -magnitude + sf;
				if (num < 0) expectedStringLength++; // Also need the negative symbol



				num = parseFloat(num.toString().substring(0, expectedStringLength+1));
				
				return num;
					
			}




			// Compute 10^n without using Math.pow for negative n which presents numerical instabilities
			function tenToThePowerOf(n, precise = true){

				if (!precise) return Math.pow(10, n);

				if (n == Infinity || n == -Infinity) return n;

				if (n == 0) return 1;
				var val = "1";
				if (n < 0) {
				
				
					for (var index = -1; index > n; index --){
						val = "0" + val;
					}
					val = "." + val;
				}

				else if (n > 0) {
					return Math.pow(10, n);

				}
				else {
					return 1;
				}
				//console.log(n, "->", parseFloat(val));
				return parseFloat(val);


			}


			function log(num, base = null){
				
				if (num == 0) return 0;
				if (base == null) return Math.log(Math.abs(num));
				return Math.log(Math.abs(num)) / Math.log(base);
				
				
			}


			// https://codepen.io/rgfx/pen/qxyGyy
			function resizable (el) {
				function resize() {el.style.width = ((el.value.length+1) * 0.5) + "em"};
				var e = 'keyup,keypress,focus,blur,change'.split(',');
				for (var i in e) el.addEventListener(e[i],resize,false);
				resize();
			}


			function resizeInput(ele){
				var int = 0.5;
				$(ele).width( (($(ele).val().length + 1) * 0.5) + "em" );
			}
			




		</script>

	</head>
	<body  onload="init()">



		<div id="measureText"></div>

		
		<div id="hoverAnnotationDiv" style="display:none">

			<div>
				<table cellpadding="5">
					<tr id="hoverAnnotationTitle">
						<td><b>Node information</b></td>
					</tr>

					<tr id="flipSubtreeBtn" class="rowbutton" title="Swap the two children of this node">
						<td>Flip subtree</td>
					</tr>

					<tr  class="rowbutton" title="Close annotation box" onclick="$('#hoverAnnotationDiv').hide(0);">
						<td>Close</td>
					</tr>
				</table>
			</div>

		</div>

		<div id="viewNav" class="sidenav" style="width:0px;">	
		
			<div class="sideNavHeader">
				View 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>

			<hr>
			
			
			<div class="sideNavSetting" style="font-size:80%">
			
				<label class="checkbox-container">
					<input type="checkbox" id="SHOW_X_AXIS" checked="checked" name="radio" onchange="setVisualParams();">
					<span class="checkmark"></span> Show x-axis
				</label>
			
				
				<label class="checkbox-container">
					<input type="checkbox" id="SHOW_Y_AXIS" checked="checked" name="radio" onchange="setVisualParams();">
					<span class="checkmark"></span> Show y-axis
				</label>

			</div>
			
			<hr>



			<div class="sideNavSetting" title="Specify annotation properties">
				Node annotations<br><br>
				<select class="dropdown speciesAnnotationsDropdown geneAnnotationsDropdown" id="MODEL_ANNOTATIONS_SPECIES" onchange="selectSpeciesAnnotationSettings();" title="Species tree annotation settings">
						<option value="_none">Select annotation...</option>
						<option value="Label">Label</option>
				</select>
				
				<div id="speciesAnnotationsMissingDataWarning" style="display:none; font-size:70%">
					Warning: missing values. Some nodes are not annotated with this annotation.
				</div>

			</div>
			
			
			<div class="sideNavSetting showOnSpeciesAnnotationSelect">
				<div><b> Data type </b></div>
				<span style="font-size:100%; vertical-align:middle">Numerical</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="speciesAnnotationDiscreteChk" OnChange="setAnnotationDataType();"> </input>
						 <span id="speciesAnnotationDiscreteSpan" class="switchslider notboolean"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Discrete</span>	
			</div>
			

	
			<div class="sideNavSetting speciesAnnotationNumerical">
				<table style="width:100%;">
					<tr id="speciesTreeAnnotationColGradient" class="colourGradientRow">
					</tr>
				</table>
				<span id="speciesAnnotationMinVal" style="font-size:70%; float:left;">Min</span>
				<span id="speciesAnnotationMaxVal" style="font-size:70%; float:right;">Max</span>
			</div>
			
			
			<table class="colourSetting speciesAnnotationNumerical">
				<tr id="speciesTreeAnnotationMinCol" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxSpeciesMin" class="colourbox" title="Select colour" onclick='openColourPicker("speciesTreeAnnotationMinCol");' style="background-color:white"></span>
					</td>
					
					<td>
						Palette min
					</td>
				</tr>
			</table>
			
			
			<table class="colourSetting  speciesAnnotationNumerical">
				<tr id="speciesTreeAnnotationMaxCol" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxSpeciesMax" class="colourbox" title="Select colour" onclick='openColourPicker("speciesTreeAnnotationMaxCol");' style="background-color:white"></span>
					</td>
					
					<td>
						Palette max
					</td>
				</tr>
			</table>
			
			
			<div class="sideNavSetting speciesAnnotationNumerical">
				Number of colours: <input type="number" min=1 max=100 step=1 id="speciesAnnotationNumCols" class="numberinput cranberry" onclick="$(this).select()" onchange="updateSpeciesAnnotationPalette(); setVisualParams();" style="width:5em">
			</div>
			
			
			<table id="speciesAnnotationDiscreteTable" class="colourSetting speciesAnnotationDiscrete">

			</table>
			
			
			
			<hr>
			

		</div>

	
			
		<div id="speciesTreeSideNav" class="sidenav" style="width:0px;">

			<div class="sideNavHeader">
				Species tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>
			
			<hr>
			

			
			<div class="sideNavSetting" id="speciesOpacityDiv">
				<input id="SPECIES_TREE_OPACITY" class="slider" onchange="setVisualParams();" type="range" min="0" max="100" value="0" step="1">
				Opacity (<span></span>%)
			</div>
			
			<hr>


			<div class="sideNavSetting">
				<input id="SPECIES_LABEL_FONT_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="60" value="0" step="0.5">
				Label font size (<span></span> px)
			</div>

			<hr>
			





			<div class="sideNavSetting" title="Species tree x axis">
				Species node width
				<select class="dropdown speciesAnnotationsDropdown numericalOnly" id="SPECIES_WIDTH_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to describe branch line width by">
						<option value="_none">None</option>
						
				</select>

			</div>
			
			<div class="sideNavSetting">
				<input id="SUBTREE_SPACER" class="slider" onchange="setVisualParams();" type="range" min="0" max="3" value="0" step="0.05">
				Horizontal spacing (<span></span>)
			</div>

		
			
			

			<hr>
			
			<div class="sideNavSetting" title="Species tree line width">
				Line width multiplier
				<select class="dropdown speciesAnnotationsDropdown numericalOnly" id="SPECIES_BRANCH_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to multiply species tree branch width baseline by">
						<option value="_none">None</option>
				</select>
			</div>
			
			
			<div class="sideNavSetting">
				<input id="SPECIES_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Line width baseline (<span></span> px)
			</div>

			<hr>
			
						

			<div class="sideNavSetting" title="Species tree line width">
				Colour branch border by
				<select class="dropdown speciesAnnotationsDropdown" id="SPECIES_BRANCH_BORDER_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branch borders by">
						<option value="_none">None</option>
						<option value="Label">Label</option>
				</select>

			</div>
			
			
			<table class="colourSetting">
				<tr id="speciesBorder" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBorder" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBorder");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch border colour
					</td>
				</tr>
			</table>
			
			
			<hr>

			
			<div class="sideNavSetting" title="Species tree line width">
				Colour branch background by
				<select class="dropdown speciesAnnotationsDropdown" id="SPECIES_BRANCH_BGCOL_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branch backgrounds by">
						<option value="_none">None</option>
						<option value="Label">Label</option>
				</select>

			</div>
			
			<table class="colourSetting">
				<tr id="speciesBG" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBG" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBG");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch background colour
					</td>
				</tr>
			</table>
			
			

			<hr>


		</div>
		
		


		<div id="geneTreeSideNav" class="sidenav" style="width:0px;">	
		
			<div class="sideNavHeader">
				Gene tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>

			<hr>
			
			<div class="sideNavSetting" title="Group gene tree nodes by genes or taxa">
				<div><b> Group gene trees by </b></div>
				<span style="font-size:100%; vertical-align:middle">Genes</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="GROUP_GENES_BY_TAXA" OnChange="setVisualParams();"> </input>
						 <span class="switchslider notboolean"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Taxa</span>	
				
			</div>
			
			
			
			<hr>


			<div class="sideNavSetting" title="Gene tree line widths">
				Node radius multiplier
				<select class="dropdown geneAnnotationsDropdown numericalOnly" id="GENE_NODE_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to describe gene node radius by">
						<option value="_none">None</option>
						<option value="Label">Label</option>
						
				</select>

			</div>


			<div class="sideNavSetting">
				<input id="GENE_NODE_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Node radius baseline (<span></span> px)
			</div>
			<hr>
			



			<div class="sideNavSetting" title="Gene tree line widths">
				Line width multiplier
				<select class="dropdown geneAnnotationsDropdown numericalOnly" id="GENE_BRANCH_MULTIPLIER" onchange="setVisualParams();" title="Tree annotation to describe branch line width by">
						<option value="_none">None</option>
						<option value="Label">Label</option>
						
				</select>

			</div>

			<div class="sideNavSetting">
				<input id="GENE_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="5" value="0" step="0.05">
				 Line width baseline (<span></span> px)
			</div>
			<hr>


			<div class="sideNavSetting" title="Species tree line width">
				Colour branches by
				<select class="dropdown geneAnnotationsDropdown" id="GENE_BRANCH_BGCOL_ANNOTATION" onchange="setVisualParams();" title="Tree annotation to colour branches by">
						<option value="_none">None</option>
				</select>

			</div>
			
			<table id="geneTreeColours"  class="colourSetting">
			
			</table>


			<hr>
			
		</div>
		
		

		<div id="innerBody">


			<div id="header">

				
			
					<ul class="flex-container thicklines" style="font-size:20%;">
				
						<li class="flex-item" style="width:30%">
						
							<div style="margin-top:5em;">
						
								<div class="textbutton left showAfterTreeUpload" onclick="uploadNewFiles()" title="Upload additional files">Open</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openDownloadDialog()" title="Download">Save As</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('viewNav')" title="Configure general visual settings">View</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('speciesTreeSideNav')" title="Configure species trees settings">Species tree</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('geneTreeSideNav')" title="Configure gene trees settings">Gene trees</div>
							</div>
						
						</li>
						
						<li class="flex-item" style="width:40%;  font-size:580%; line-height:120%">
							UglyTrees
							<div class="subheader">A multispecies coalescent tree visualiser </div>	
						</li>
						
						
						<li class="flex-item" style="width:30%">
							
						</li>
						

					</ul>
				
				
			</div>



			<div id="main">

				<table id="fileUploading" cellspacing=10>
					<tr>
						<td style="width:45%">
							<div id="species_tree_upload" class="uploader">
								<div>Upload a species tree file</div>
								<table id="speciesTreeUploadTable"">
								</table>
								
							</div>
						</td>

						<td style="text-align:center" colspan=2>
							<br><br><br><br>
							<span id="renderTreesBtn" onclick="userSaysDraw();" class="button large disabled">Draw trees</span>
						</td>

						<td style="width:45%">
							<div id="gene_tree_upload" class="uploader">
								<div>Upload one or more gene tree files</div>
								<table id="geneTreeUploadTable">
								</table>
							</div>
						</td>
					</tr>
					
					
				</table>		

				<svg id="tree" height=0 width=0 easypz='{"applyTransformTo": "svg > *",  "onTransformed": "svgZoomed",  "modes": ["SIMPLE_PAN", "WHEEL_ZOOM_MOMENTUM", "PINCH_ZOOM_MOMENTUM"], "options": { "minScale": 1, "maxScale": 50, "bounds": { "top": 0, "right": 0, "bottom": 0, "left": 0 }} }'  ></svg>
			</div>

<!--easypz='{"applyTransformTo": "svg > *", "options": { "minScale": 0.8, "maxScale": 10, "bounds": { "top": -50, "right": 50, "bottom": 50, "left": -50 }} }' width="400" height="400">-->

			<div id="footer" >


				
 				

				<span title="Skip backwards (ctrl + &larr;)" class="arrow" onclick="prevTree(true)">&#xab;</span> 
				<span title="Go to previous tree (&larr;)" class="arrow" onclick="prevTree()">&#x2039;</span> 
				<span id="treeNumContainer">Tree number: <input class="numberinput cranberry" type="number" id="treeNum" style="width:2em; font-size:100%" onchange="setTree()"  value=0></input></span>
				<span title="Go to next tree (&rarr;)" class="arrow" onclick="nextTree()">&#x203A;</span>
				<span title="Skip forward (ctrl + &rarr;)" class="arrow" onclick="nextTree(true)">&#xbb;</span> 

				<span title="Play" id="playBtn" class="arrow" style="font-size:150%" onclick="play()">&#9654;</span> 
				<span title="Stop" id="stopBtn" class="arrow" style="font-size:180%; display:none" onclick="stop()">&#9632;</span> 



				
			</div>

		</div>

	</body>




</html>
