<html>

	<!--
	
	MIT License

	Copyright (c) 2019 UglyTrees

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.

	-->

	<head>
		<title>UglyTrees</title>

		<style>

			@import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro');


			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}


			.loader {
				border: 16px solid white; 
				border-top: 16px solid #DB5079; 
				border-radius: 50%;
				width: 20px;
				height: 20px;
				animation: spin 2s linear infinite;

			}
			
			line.selected {
				stroke: #DB5079 !important;
				stroke-width: 3px !important;
			}
			
			circle.selected {
				fill: #DB5079 !important;
			}
			
	
			#tree{
				z-index:100;
			
			}
			


			body {
				font-family: "Source Sans Pro", "Arial"; 
				background-color:white;
				width:100%;
				min-width:500px;
				height:300px;
				min-height:100%;
				margin:0;
				padding:0;
			}


			.dz-preview{
				display:none;
			}

			svg{
				%border-style:solid;
				border-width:0.5px;
			}


			html {
			    height: 100%;
			}


			table {
			   	%font-family: Courier New; 
				font-size:16px;
				position:relative;
			}

			table td {
				margin:0;
			}

			table {
			   	border-collapse: collapse;
			}

			.node {
				cursor:pointer;
			}

			.button{
				transition: all 0.2s ease 0s;
				border-radius:5px;
				padding: 5;
				margin-right:10px;
				margin-left:10px;
				border-color:black;
				border-style:solid;
				border-width:1px;
				cursor:pointer;-webkit-user-select: none; /* Chrome/Safari */        
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;
			}
			
			.button.large{
				font-size:150%;
				padding: 10;
			}
			
			.button.disabled {
				background-color:#696969;
				cursor:auto;
				color:white;
			}


			.button:hover{
				color:white;
				background-color:#DB5079;
			}
			
			.button.disabled:hover {
				background-color:#696969;
			}


			#main{
				margin-left:50px;
				margin-right:20px;
			}

			.outlinedText{
				color:white;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}

			
			.colourbox{
				%height: 40px;
				padding-left:1.6em;
				padding-top:5px;
				padding-top:5px;
				margin-right:3px;
				border-radius: 2px;
				border-color: black; 
				border-style:solid;
				border-width:1px;
				cursor:pointer;
			}
			
			.colourbox.selected{
				border-width:3px;
			}

			.dialog{

				z-index:1000;
				position:fixed;
				width:50%;
				text-align:center;
				margin-left:25%;
				top:20vh; 
				%min-height:200px;
				text-align:center;
				background-color:#708090; 
				padding: 10 10; 
				%margin:auto;
				border-radius: 5px;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
			}


			.dialog.toTheSide{
				position:relative;
				margin-left:0;
				%top:10vh;
				width:100%;
				margin-bottom:100;
			}


			.dialog_inner{
				background-color: white; 
				padding: 10 10; 
				text-align:center; 
				font-size:15; 
				overflow-y:auto
			}


			.glowing {
				%filter: invert(100%);
				background-color:orange;
				color:white; 
				border-radius:5px;
				border-color: #FFFFB2; 
				 -webkit-box-shadow: 0 0 10px #FFFFB2; 
				   -moz-box-shadow: 0 0 10px #FFFFB2; 
				    box-shadow: 0 0 10px #FFFFB2; 
			}


			.annoyingFlash{
				color:red;
				position:fixed;
				font-family: "Comic Sans";
				top: 50%;
				bottom: 50%;
				font-size: 5em; 
				text-align: center;
				width:100%;
			}



			.numberinput{
			
				background: transparent;
				background-color:white;
				color:black;
				border-color:black;
				border-style:solid;
				border-width:1px;
				min-width:10px!important;
				max-width:99.99%!important;
				transition: width 0s;
				padding: 5;
			}
			
			.numberinput.cranberry{
				background-color:#DB5079;
				border: none;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
				color:white;
			}


			input[type=number]::-webkit-inner-spin-button, 
			input[type=number]::-webkit-outer-spin-button { 
			  -webkit-appearance: none; 
			  margin: 0; 
			}

			input[type=number] {
			    -moz-appearance:textfield; /* Firefox */
			}


			#header{
				text-align:center;
				font-size:450%;
				line-height:1.3em;
				background-color:#DB5079;
				color:white;
				width:99%;
				margin-left:0.5%;
				padding:0;
				margin-bottom:5;
				border-radius:0px 0px 20px 20px;
				border-color:black;
				border-style:solid;
				border-width:1px;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}


			#footer{
				z-index:1;
				text-align:center;
				line-height:3em;
				background-color:#DB5079;
				font-size:100%;
				color:white;
				width:99%;
				margin-left:0.5%;
				padding:0;
				margin-top:5;
				border-radius:20px 20px 0px 0px;
				%border-color: white; 
				%border-style:solid;
				%%border-width:2px;
				position:fixed;
   				bottom:-5px;
				border-color:black;
				border-style:solid;
				border-width:1px;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
				vertical-align:bottom;


				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;
			}


			.subheader{
				margin-top:-0.65em;
				font-size:23%;
				line-height:1.7em;
			}

			.rotate90{
				transform: rotate(90deg);
			}
			
			.rotate180{
				transform: rotate(180deg);
			}
			
			.rotate270{
				transform: rotate(270deg);
			}


			.sideTab {
				transition: all 0.2s ease 0s;
				position: absolute;
				left: -5px;
				font-size:120%;
				transform: rotate(-90deg);
				transform-origin: left top 0px;
				padding: 5px 10px;
				color: black;
				border-radius: 0px 0px 20px 20px;
				z-index: 3;
				margin-left: 0px;
				border-color:black;
				border-style:solid;
				border-width:1px;
				cursor:pointer;				
				cursor:pointer;-webkit-user-select: none; /* Chrome/Safari */        
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;
			}


			.sideTab:hover{
				color:white;
				background-color:#DB5079;
			}
			
			#treeNumContainer{
				font-size:140%;
			}
			 
			.icon{
				width:40px;
				height:40px;
				cursor:pointer;
				padding: 3;
			
			}

			.arrow{
				position:relative;
				bottom: 0px;
				font-size:300%;
				%line-height:0.1em;
				%padding: 5;
				margin-left:5px;
				margin-right:5px;
				padding:0;
				margin-bottom:0px;
				cursor:pointer;
				color:white;
			}

			.arrow:hover{
				color:black;
			}


			#fileUploading{
				width:100%;
				min-height:300px;
				height:400px;
				margin-top:100px;
			}



			#fileUploading td{
				width:50%;
			}


			.uploader {
				height:100%;
				border-style:dashed;
				border-radius: 20px;
				text-align:center;
				vertical-align:middle;
				margin: 20px;
			}
			
			
			.uploader.dz-drag-hover, .uploader:hover {
				background-color:#DB5079;
			}

			.uploader  div {
				font-size:200%;
				margin-top: 150px;
				color:#DB5079;
				padding: 10;
				%text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}
			
			
			.uploader.dz-drag-hover div, .uploader:hover div {
				color:white;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}
			
			@import "compass/css3";


			.thicklines {
				line-height:3em;
			
			}
			
			.dropdown{
				background-color:#DB5079;
				padding:5;
				color:white;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}
			
			
			.dropdown:after{
				width: 0; 
				height: 0; 
				border-left: 6px solid transparent;
				border-right: 6px solid transparent;
				border-top: 6px solid #f00;
				position: absolute;
				top: 40%;
				right: 5px;
				content: "";
				z-index: 98;
			}
			
			.dropdown select{
				width: 220px;
				border: 0;
				position: relative;
				z-index: 99;
				background: none;
			}

			.flex-container {
				padding: 0;
				margin: 0;
				list-style: none;
				%text-align:left;

				display: -webkit-box;
				display: -moz-box;
				display: -ms-flexbox;
				display: -webkit-flex;
				display: flex;

				-webkit-flex-flow: row wrap;
				justify-content: space-around;
				%vertical-align:bottom;
				justify-content: left;
				margin-left:1em;
			}

			.flex-item {
				%width: 33%;
				%text-align:left;
				%margin-left:0.5em;
			}
			
			
			.textbutton{
				cursor:pointer;
				vertical-align:bottom;
				font-size:120%;
				
				
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;
			}
			
			
			.textbutton.left{
				margin-left:1.5em;
				float:left;
			}
			
			.textbutton.right{
				margin-right:1.5em;
				float:right;
			}
			
			
			.textbutton:hover{
				color:black;
				text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
			}
			
			
			#innerBody {
				transition: 0.5s;
			
			}
			
			.sidenav {
				height: 100%;
				width: 0;
				position: fixed;
				z-index: 4;
				top: 0;
				left: 0;
				background-color: white;
				overflow-x: hidden;
				overflow-y:scroll;
				transition: 0.5s;
				padding-top: 20px;
				text-align:left;
			}

			.sideNavHeader{
				text-align:center;
				font-size:150%;
				line-height:1.3em;
				background-color:#DB5079;
				color:white;
				padding:5;
				border-color:black;
				border-style:solid;
				border-width:1px;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			
			}
			
			
			.sidenav .closebtn {
				float:right;
				text-decoration:none;
				color:white;
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}
			
			
			.sidenav .closebtn:hover {
				color:black;
				text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
			}
			
			/* The switch - the box around the slider */
			.switch {
				position: relative;
				display: inline-block;
				width: 4em;
				height: 2em;
				vertical-align:middle;
			}

			/* Hide default HTML checkbox */
			.switch input {display:none;}
			
			
			
			.switchslider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				-webkit-transition: .3s;
				transition: .3s;
				border-radius: 2em;
			}
			
			
			
			.switchslider:before {
				position: absolute;
				content: "";
				height: 1.5em;
				width: 1.5em;
				left: 0.25em;
				bottom: 0.25em;
				background-color: white;
				-webkit-transition: .3s;
				transition: .3s;
				border-radius: 50%;
			}


			label {
				-webkit-user-select: none;  
				-moz-user-select: none;    
				-ms-user-select: none;      
				user-select: none;
			}

			.notboolean{
				background-color: #DB5079;	
			}
			
			input:checked + .switchslider {
				background-color: #DB5079;		
			}

			input:focus + .switchslider {
				box-shadow: 0 0 1px #DB5079;
			}

			input:checked + .switchslider:before {
				-webkit-transform: translateX(2em);
				-ms-transform: translateX(2em);
				transform: translateX(2em);
			}
			
			.input[type=checkbox].modelSetting {
				vertical-align:middle;
			}
			
			input {
				box-shadow: none;
			}



			.slider {
				-webkit-appearance: none;
				width: 100%;
				height: 15px;
				border-radius: 20px;  
				background: #DB5079;
				outline: none;
				%opacity: 0.7;
				-webkit-transition: .2s;
				transition: opacity .2s;
				border-color:black;
				border-style:solid;
				border-width:1px;
			}

			.slider:hover {
				%opacity: 1;
			}

			.slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 25px;
				height: 25px;
				border-radius: 50%; 
				background: white;
				cursor: pointer;
				border-color:black;
				border-style:solid;
				border-width:1px;
			}

			.slider::-moz-range-thumb {
				width: 25px;
				height: 25px;
				border-radius: 50%;
				background: white;
				cursor: pointer;
				border-color:black;
				border-style:solid;
				border-width:1px;
			}
			
			
			.sideNavSetting{
				width:80%;
				margin-left:10%;
				margin-top:20px;
				text-align:center;
			}

			
			#geneTreeColours, #speciesTreeLineColours, #speciesTreeBGColours{
				width:100%;
				margin-top:20px;
				margin-left:2px;
				margin-right:2px;
			}

			#geneTreeColours td, #speciesTreeLineColours td, #speciesTreeBGColours td{
				padding-top: 0.35em;
				padding-bottom: 0.35em;
				font-size:90%;
				text-align:left;
			}
			
			
			.checkbox-container{
				display: block;
				position: relative;
				padding-left: 35px;
				margin-bottom: 12px;
				cursor: pointer;
				font-size: 140%;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;

			}
			
			.checkbox-container.small{
				font-size:100%;
			 }
			
			
			/* Hide the browser's default checkbox */
			.checkbox-container input {
				position: absolute;
				opacity: 0;
				cursor: pointer;
				height: 0;
				width: 0;
			}

			/* Create a custom checkbox */
			.checkmark {
				position: absolute;
				top: -0.4em;
				left: 0.25em;
				height: 1em;
				width: 1em;
				color:black;
				background-color: white;
				border-radius:10px;
				border-color:black;
				border-style:solid;
				border-width:1px;
			}
			
			.checkbox-container.small .checkmark{
				left: 0.5em;
			}
			
			
			/* On mouse-over, add a background color */
			.checkbox-container:hover input ~ .checkmark {
				background-color: #DB5079;
			}

			/* When the checkbox is checked, add a cranberry background */
			.checkbox-container input:checked ~ .checkmark {
				background-color: #DB5079;
				
			}

			/* Create the checkmark/indicator (hidden when not checked) */
			.checkmark:after {
				content: "";
				position: absolute;
				display: none;
			}

			/* Show the checkmark when checked */
			.checkbox-container input:checked ~ .checkmark:after {
				display: block;
			}

			/* Style the checkmark/indicator */
			.checkbox-container .checkmark:after {
				left: 0.32em;
				top: 0.15em;
				width: 0.25em;
				height: 0.5em;
				border: solid white;
				border-width: 0 3px 3px 0;
				-webkit-transform: rotate(45deg);
				-ms-transform: rotate(45deg);
				transform: rotate(45deg);
				text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
			}
								

		</style>

		
	<script type="text/x-mathjax-config">
	  MathJax.Hub.Config({
	    tex2jax: {
	      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
	      processEscapes: true
	    }
	  });
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script language='JavaScript' type='text/JavaScript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/tree.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/icytree-master/js/treeparsing.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/drawTrees.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/visualsettings.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/util.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/velocity.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src='lib/d3.v5.min.js'></script> 
		<script language='JavaScript' type='text/JavaScript' src="lib/dropzone.js"></script>
		<script>


		


			function init(){


				
				SVG_TOP_MARGIN = 20;
				SVG_BOTTOM_MARGIN = 5;
				SVG_UNDER_BOTTOM_MARGIN = 25;
				SVG_LEFT_MARGIN = 20;
				SVG_RIGHT_MARGIN = 20;
				SPECIES_LEAVES = [];
				textLabelPadding = 5;
				SPECIES_TREE = null;
				GENE_TREES = [];
				MAX_TREE_HEIGHT = 0;
				SPECIES_TREES_ALL = [];
				GENE_TREES_ALL = [];
				READY_TO_DRAW = false;

				SVG_HEIGHT = 0;
				SVG_WIDTH = 0;
				GAP_BETWEEN_SUBTREES = 0;

				var svg = $("#tree");
				svg.html("");
				svg.height(SVG_HEIGHT);
				svg.width(SVG_WIDTH);

				
				yScaler = 1;
				BURNIN = 0.1;
				TREE_NUM = 0;
				NTREES = 0;
				
				
				
				initVisualSettings();
				

				$("#treeNum").val(0);
				resizable(document.getElementById("treeNum"));
				//$(".showAfterTreeUpload").hide(0);
				
				$("#speciesTreeUploadMsg").hide(0);
				$("#geneTreeUploadMsg").hide(0);


				// Operator
				SPECIES_TREE_X = null;
				ALPHA = 0; 		
				ALPHA_WINDOW = 0.003;
				$("#windowInput").val(ALPHA_WINDOW);
				revALPHA = 1;


				var speciesTreeDropzone = new Dropzone("div#species_tree_upload", { url: "/file/post"});
				speciesTreeDropzone.on("addedfile", function(file) {
					
					addLoader("#species_tree_upload", "treeLoader");
					var reader = new FileReader();

					// Closure to capture the file information.
					reader.onload = (function(theFile) {
						return function(e) {

							if (e == null || e.target.result == "") return;
							try {
								SPECIES_TREES_ALL = getTreesFromString(e.target.result);
							} 
							catch(err){
								$("#speciesTreeUploadMsg").html("<b>Error parsing " + theFile.name + ":</b>  " + err.message);
								$("#speciesTreeUploadMsg").show(300);
								$("#treeLoader").remove();
								return;
							}
							
							NTREES = SPECIES_TREES_ALL.length;
							TREE_NUM = Math.floor(NTREES * BURNIN) + 1;
							console.log(theFile);
							$("#speciesTreeUploadMsg").html(theFile.name + " successfully parsed<br>");
							$("#speciesTreeUploadMsg").show(300);
							if (SPECIES_TREES_ALL.length > 0 && GENE_TREES_ALL.length > 0) $("#renderTreesBtn").removeClass("disabled");
							$("#treeLoader").remove();

						};

					})(file);

					reader.readAsText(file);

				});




				var geneTreeDropzone = new Dropzone("div#gene_tree_upload", { url: "/file/post"});
				geneTreeDropzone.on("addedfile", function(file) {
					
					addLoader("#gene_tree_upload", "treeLoader");

					var reader = new FileReader();

					// Closure to capture the file information.
					reader.onload = (function(theFile) {
						return function(e) {

							if (e == null || e.target.result == "") return;

							try{
								var tree = getTreesFromString(e.target.result);
								tree.name = theFile.name;
								GENE_TREES_ALL.push(tree);
							} 
							catch(err){
								$("#geneTreeUploadMsg").append("<b>Error parsing " + theFile.name + ":</b>  " + err.message);
								$("#geneTreeUploadMsg").show(300);
								$("#treeLoader").remove();
								return;
							}
							



							$("#geneTreeUploadMsg").append(theFile.name + " successfully parsed<br>");
							$("#geneTreeUploadMsg").show(300);
							if (SPECIES_TREES_ALL.length > 0 && GENE_TREES_ALL.length > 0) $("#renderTreesBtn").removeClass("disabled");
							$("#treeLoader").remove();
							
							renderGeneTreeColourSettings();
							

						};

					})(file);

					reader.readAsText(file);

				});

			

				/*

				loadFileAsString("trees/starbeast3_UCLN.species.trees", function(str1) { loadFileAsString("trees/starbeast3_UCLN.gene26.trees", function(str2) { loadFileAsString("trees/starbeast3_UCLN.gene29.trees", function(str3) {

					SPECIES_TREES_ALL = getTreesFromString(str1);

					GENE_TREES_ALL = [];
					GENE_TREES_ALL.push(getTreesFromString(str2));
					GENE_TREES_ALL.push(getTreesFromString(str3));

					NTREES = GENE_TREES_ALL[0].length;
					TREE_NUM = Math.floor(NTREES * BURNIN) + 1;
					renderTrees();

				}); }); });

				*/

			}

			function updateAlphaWindow() {
				ALPHA_WINDOW = parseFloat($("#windowInput").val());
			}

			function nextTree(toEnd = false) {
				if (toEnd) TREE_NUM = NTREES-1;
				else if (TREE_NUM >= NTREES-1) return;
				else TREE_NUM++;
				renderTrees();

			}


			function prevTree(toEnd = false) {
				if (toEnd) TREE_NUM = 0;
				else if (TREE_NUM <= 0) return;
				else TREE_NUM--;
				renderTrees();

			}


			function setTree(){

	
				var newVal = parseFloat($("#treeNum").val());
				if (TREE_NUM == newVal) return;
				TREE_NUM = newVal;
				if (TREE_NUM < 0) TREE_NUM = 0;
				if (TREE_NUM >= NTREES) TREE_NUM = NTREES-1;
				renderTrees();
			}


			function addLoader(eleAddTo, id = "loader"){
				$(eleAddTo).append(`<div  id="` + id + `" title="Loading file..." class="loader" style="margin:auto"></div>`);
			}


			// Don't redraw the tree until the user has stopped resizing for a period of time
			var resizeId;
			$(window).resize(function() {
				$("#tree").html("");
				closeDialogs();
				clearTimeout(resizeId);
				resizeId = setTimeout(doneResizing, 300);
			});

			function doneResizing(){
			    renderTrees();
			}

			
			function userSaysDraw(){
				READY_TO_DRAW = true;
				renderTrees();
			}


			function renderTrees(options = null) {


				if (SPECIES_TREES_ALL.length == 0 || GENE_TREES_ALL.length == 0 || !READY_TO_DRAW) return;
				$("#fileUploading").hide(0);
				$(".showAfterTreeUpload").show(0);
				
				SPECIES_TREE_X = null;
				unhover();
				$(".dialog").remove();

				
				GENE_TREES = [];
				for (var g = 0;  g < GENE_TREES_ALL.length; g ++){
					GENE_TREES.push(GENE_TREES_ALL[g][TREE_NUM]);
				}


				SPECIES_TREE = SPECIES_TREES_ALL[TREE_NUM];
				SPECIES_TREE.geneNodeMap = {};
				//console.log("speciesTree", SPECIES_TREE);
	


				var svg;
				if (options == null) {

					svg = $("#tree");
					svg.html("");
					svg.height(0);
					svg.width(0);


					SVG_HEIGHT = parseFloat($("body").height()) - parseFloat($("#header").height()) - parseFloat($("#footer").height()) - SVG_UNDER_BOTTOM_MARGIN;
					SVG_WIDTH = parseFloat($("#main").width());
					

					svg.height(SVG_HEIGHT);
					svg.width(SVG_WIDTH);
					
				
				}else{
					svg = $(options.svgSelector);
					svg.html("");
					svg.height(options.height);
					svg.width(options.width);
				}


				$("#treeNum").val(TREE_NUM);
				resizeInput($("#treeNum"));


				// Get max tree height 
				MAX_TREE_HEIGHT = SPECIES_TREE.root.height;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					MAX_TREE_HEIGHT = Math.max(MAX_TREE_HEIGHT, GENE_TREES[g].root.height);
				}


				var totalNAtLeaves = 0;
				SPECIES_LEAVES = [];
				for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
				
					var node = SPECIES_TREE.nodeList[i];
					node.rate = node.annotation["branchRates.Species"] = null ? 1 : parseFloat(node.annotation["branchRates.Species"]);
					node.populationsize = node.annotation["pop"] == null ? 1 : parseFloat(node.annotation["pop"]);
					node.coords = { bottomLeft: {x: -1, y: -1}, bottomRight: {x: -1, y: -1}, topLeft: {x: -1, y: -1}, topRight: {x: -1, y: -1}, dashed: {left: -1, right: -1}, xrange: {left: -1, right: -1} };
					node.coordsStored = JSON.parse(JSON.stringify(node.coords));
					node.branchToGeneNodeMap = []; // Maps species branch to gene nodes
					node.nodeToGeneBranchMap = []; // Maps species nodes to gene branches
					
					for (var g = 0; g < GENE_TREES.length; g++){
						node.branchToGeneNodeMap[g] = {};
						node.nodeToGeneBranchMap[g] = {};
					}

					//console.log(i, SPECIES_TREE.nodeList[i].populationsize);
					
					if (node.label != null) {	
						node.height = 0;
						totalNAtLeaves += node.populationsize;
						SPECIES_LEAVES.push(node);
					}
				}
				
				GAP_BETWEEN_SUBTREES = SUBTREE_SPACER * totalNAtLeaves / SPECIES_LEAVES.length;
				
				planSpeciesTree(SPECIES_TREE.root);
				scaleTreeRanges(SPECIES_TREE, SVG_LEFT_MARGIN, svg.height()-SVG_BOTTOM_MARGIN-GENE_NODE_SIZE, svg.width()-SVG_RIGHT_MARGIN, SVG_TOP_MARGIN);
	
				console.log("SPECIES_TREE", SPECIES_TREE);
				drawASpeciesTree(svg, SPECIES_TREE, "speciestree", SPECIES_TREE.root);
				storeTree(SPECIES_TREE.root);

			
				// Count number of displayed gene trees
				var numToDisplay = 0;
				for (var g = 0; g < GENE_TREES.length; g++){
					if (GENE_TREE_DISPLAYS[g] == null || GENE_TREE_DISPLAYS[g] == true) numToDisplay++;
				}
			
			
				// Add gene tree offsets so that nodes don't overlap
				var numVisibleTreesCumulative = 0;
				for (var g = 0;  g < GENE_TREES.length; g ++){
					if (GENE_TREE_DISPLAYS[g] == null || GENE_TREE_DISPLAYS[g] == true) {
						GENE_TREES[g].offsetIndex = numVisibleTreesCumulative;
						numVisibleTreesCumulative++;
					}
					GENE_TREES[g].offsetTotal = numToDisplay;
				}
			

				// Draw the gene tree
				for (var g = 0; g < GENE_TREES.length; g++){

					var gene_tree = GENE_TREES[g];
					//gene_tree.speciesNodeMap = {};
					
					
					// Do not render if unchecked
					if (GENE_TREE_DISPLAYS[g] != null && GENE_TREE_DISPLAYS[g] == false) continue;
					
		
					// Get the leaves
					var leaves = [];
					for (var i = 0; i < gene_tree.nodeList.length; i ++) {
						var geneNode = gene_tree.nodeList[i];
						geneNode.speciesNodeMap = null;
						geneNode.coords = { cx: -1, cy: -1, x: [], y: [], strokeWidths: [] };
						geneNode.coordsStored = JSON.parse(JSON.stringify(geneNode.coords));
						
						
						if (geneNode.children.length == 0) {
							leaves.push(geneNode);
							geneNode.height = 0;
						}
					}
					
					
					// Map the leaves to species leaves
					for (var i = 0; i < SPECIES_LEAVES.length; i ++){

						var gene_leaves_for_species = [];
						for (var j = 0; j < leaves.length; j ++) {
							var leaf = leaves[j];
							var speciesOfGene = leaf.label.split("_")[1];
							//console.log(speciesOfGene, SPECIES_LEAVES[i].label);
							if (SPECIES_LEAVES[i].label == speciesOfGene) {
								SPECIES_LEAVES[i].branchToGeneNodeMap[g][leaves[j].id] = leaves[j];
								SPECIES_LEAVES[i].nodeToGeneBranchMap[g][leaves[j].id] = leaves[j];
								
								leaves[j].speciesNodeMap = SPECIES_LEAVES[i]
								//gene_leaves_for_species.push(leaf);
							}

						}


					}
					

					//drawGeneTree(svg, "gene" + g, gene_tree, gene_tree.root, true);
					buildGeneTreeSpeciesTreeMap(g, gene_tree.root);
					planGeneTree(g, gene_tree.root, gene_tree, GROUP_GENES_BY_TAXA);
					drawAGeneTree(svg, "gene" + g, gene_tree.root, SPECIES_TREE, g, {col: getGeneTreeColour(g)});
					console.log("gene_tree", gene_tree);
					console.log("SPECIES_TREE", SPECIES_TREE);
					

				}


				

			




			}


			function operate(step = 1) {

				


				var desc = "";
				switch(step) {

					case 1: {
						restoreTree(SPECIES_TREE.root);
						if (SPECIES_TREE_X != null) moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
						$("#sampledAlpha").html("");
						desc = `Sample an internal node $x$ from the species tree $S$. Let $t_x$, $r_x$, and $N_x$ be its time, rate, and effective population size, respectively.`;
						//desc = `$x$`;
						break;
					}

					case 2: {
						desc = `Sample $\\alpha \\sim \\text{Uniform}(-w, w)$ for some window size $w$.`;
						break;
					}

					case 3: {
				
						desc = `Propose a new node time for $x$ as <br><br> $ {t_x}^\\prime \\leftarrow  t_x + \\alpha$ <br><br> Ensure that $\\max\\{t_{L}, t_{R} \\} < {t_x}^\\prime < t_{P}$. `;
						break;
					}
					case 4: {

						if (ALPHA != 0 && revALPHA == 1) moveSpeciesTreeNode(SPECIES_TREE_X, ALPHA)
						desc = `Propose new rates for the following species tree nodes: <br><br> 
							{r_x}^\prime &\leftarrow r_x \times  \frac{t_{P} - t_x}{t_{P} - {t_x}^\prime } \tag{$f_2$} <br> 
							{r_{L}}^\prime &\leftarrow r_{L} \times  \frac{t_x - t_{L}}{{t_x}^\prime - t_{L} } \tag{$f_3$} <br> 
							{r_{R}}^\prime &\leftarrow r_{R} \times  \frac{t_x - t_{R}}{{t_x}^\prime - t_{R} } \tag{$f_4$}`;
						break;
					}
					case 5: {
						desc = ``;
						break;
					}
					case 6: {
						desc = ``;
						break;
					}

					case 7: {
						desc = ``;
						break;
					}


				}


				$(".dialog").remove();
				$("body").append(getstepDialogTemplate(step, desc));
				//var math=MathJax.Hub.getAllJax("dialogDesc")[0];
				//MathJax.Hub.Queue(["Text",math,desc]); 

				

			}




			function doOperation(step = 1){


				// Move the template
				jQuery("#operatorDialog").detach().appendTo("#operatorPanel");
				$("#operatorDialog").addClass("toTheSide");
				$("#dialogBtn").html("Next");
				$("#dialogBtn").attr("onclick", "operate(" + (step + 1) + ")");

				$("#dialogBtnRev").hide(0);
				switch(step) {

					case 1: {
						
						// Sample a node
						var speciesTreeInternalNodes = [];
						for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
							if (SPECIES_TREE.nodeList[i].parent != null && SPECIES_TREE.nodeList[i].children.length == 2) {
								speciesTreeInternalNodes.push(SPECIES_TREE.nodeList[i]);
							}
						}
						SPECIES_TREE_X = speciesTreeInternalNodes[Math.floor(Math.random() * speciesTreeInternalNodes.length)];
						highlightNode(SPECIES_TREE_X.htmlID + "_P");
						break;
					}

					case 2: {

						// Sample alpha
						ALPHA = roundToSF(Math.random() * 2 * ALPHA_WINDOW - ALPHA_WINDOW);
						$("#sampledAlpha").html(ALPHA);

						makeItGlow($("#sampledAlpha").parent());

						break;
					}

					case 3: {

						revALPHA = -1;
						$("#dialogBtnRev").show(0);
						$("#dialogBtnRev").click(function() {
							if (revALPHA == -1) restoreTree(SPECIES_TREE_X, ALPHA * revALPHA);
							else restoreProposedTree(SPECIES_TREE_X, ALPHA * revALPHA);
							moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
							revALPHA *= -1;
						});


						//console.log(SPECIES_TREE_X, SPECIES_TREE_X.height, SPECIES_TREE_X.height + ALPHA, SPECIES_TREE_X.parent.height, SPECIES_TREE_X.children[0].height, SPECIES_TREE_X.children[1].height);

					


						var accepted = proposeMoveSpeciesTreeNode(SPECIES_TREE_X, ALPHA);
						
						if (!accepted) {
						
							// Reject
							addAnnoyingFlashMessage("Rejected");
							$("#dialogDesc").append(`<br><br><b>Proposal rejected. Try again.</b>`);
							$("#dialogBtn").hide(0);
							console.log("Reject");

						}
						
						moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);



						break;
					}
					case 4: {

						break;
					}
					case 5: {

						break;
					}
					case 6: {

						break;
					}

					case 7: {

						break;
					}

				}


			}



			function getstepDialogTemplate(stepNum, desc){
				return `
						<div id="operatorDialog" class="dialog">
							<div class="dialog_inner">
							<h2>Step ` + stepNum + `</h2>

								<div id="dialogDesc" style="font-size:120%">` + desc + `</div><br>
								
								
								<span id="dialogBtn" onclick=doOperation(` + stepNum + `) style="float:right" class="button">Do it</span>
								<span id="dialogBtnRev" style="display:none; float:right" class="button">Undo</span>
							</div>
						</div>

					`;

			}



			function addAnnoyingFlashMessage(msg) {

				$("body").append(`<div class="annoyingFlash">` + msg + `</div>`);


				$(".annoyingFlash").animate({
					fontSize: "200em",
					color: "yellow"
			    	}, 2000);

				setTimeout(function() {
					$(".annoyingFlash").remove();
				}, 2000);

			}
			






			function drawSVGobj(svg, type, attr, val = null, isNode = false, addBackground = false){

				//console.log("attr", attr);
				var newObj = document.createElementNS('http://www.w3.org/2000/svg', type);
				for (var a in attr){
					if (a == "text_anchor") newObj.setAttribute("text-anchor", attr[a]);
					else if (a == "alignment_baseline") newObj.setAttribute("alignment-baseline", attr[a]);
					else if (a == "stroke_dasharray") newObj.setAttribute("stroke-dasharray", attr[a]);
					else newObj.setAttribute(a, attr[a]);
				}
				if (val != null) newObj.innerHTML = val;



				// Set some of the styles as attributes because safari and IE do not like styles for svgs
				var styles = getComputedStyle(newObj);
				//if (styles.fill != null) newObj.setAttribute("fill", styles.fill);
				if (styles.stroke != null) newObj.setAttribute("stroke", styles.stroke);
				if (styles["stroke-width"] != null) newObj.setAttribute("stroke-width", styles["stroke-width"]);
				if (isNode) newObj.setAttribute("class", "node");
				//console.log(styles["stroke-width"]);


				svg.append(newObj);

				
				if (isNode && attr.id != null){
					$("#" + attr.id).hover(function() { hoverNode(attr.id) },  function() {  });
				}
				
				
				// Add a background box behind the label
				if (addBackground && attr.id != null) {
					
					var boundingBox = document.getElementById(attr.id).getBBox();						
					var bg = drawSVGobj(svg, "rect", {class: "barLabelBg", 	x: boundingBox.x - textLabelPadding,
																y: boundingBox.y - textLabelPadding,
																width: boundingBox.width + 2*textLabelPadding,
																height: boundingBox.height + 2*textLabelPadding,
																style: "fill:#d3d3d3"});
				
					$(bg).prev().insertAfter($(bg));

				}

				
				return newObj;

			}	



			function makeItGlow(ele, remainingFlashes = 3){

				if (remainingFlashes <= 0) return;


				ele.addClass("glowing");

				
				setTimeout(function() { 
					ele.removeClass("glowing");
					setTimeout(function() { 
						makeItGlow(ele, remainingFlashes-1);
					}, 300);
				}, 300);

			}


			function highlightNode(id){
			
				//console.log("highlighting", id);
				$("#" + id).attr("fill", "#008cba");
				$("#" + id).attr("opacity", "0.5");

			}


			function hoverNode(id){

			
				return;
				
				
				unhover();

				

				if(SPECIES_TREE_X != null) highlightNode(SPECIES_TREE_X.htmlID + "_P");


				if($("#" + id).attr("name") == null) return;

				$("#currentNodeName").html("(" + $("#" + id).attr("name") + ")");


				//console.log("node.id", id);

				var treeName = id.split("_")[0];

			
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);



				if (treeName != "speciestree") {
					//$(`[branchfornode="` + id + `"].genebranch`).css("stroke", "#DB5079");
					//$(`[branchfornode="` + id + `"].genebranch`).css("stroke-width", "3px");
					$(`[branchfornode="` + id + `"].genebranch`).addClass("selected");
					$("#" + id).addClass("selected");
					
				}else {
					$("#" + id).attr("opacity", "0.5");
					$("#" + id).attr("fill", "#DB5079");
					
					// Get the node
					for (var s = 0; s < SPECIES_TREE.nodeList.length; s++){
						if (SPECIES_TREE.nodeList[s].id == nodeID){
							var node = SPECIES_TREE.nodeList[s];
							for (var g = 0; g < GENE_TREES.length; g++){
							
								console.log(g, GENE_TREES.length);
							
								for (var m in node.branchToGeneNodeMap[g]){
									$("#gene" + g + "_" + m).addClass("selected");
								}
								
								for (var m in node.nodeToGeneBranchMap[g]){
									$(`[branchfornode="gene` + g + `_` + m + `"].genebranch`).addClass("selected");
								}
								
							}
							
	
							
							break;
													
							
						}
					
					}
					
				}




				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}

				$("#currentNodeTime").html(roundToSF(node.height));
				$("#currentNodeRate").html(roundToSF(node.rate));
				$("#currentNodeSize").html(roundToSF(node.populationsize));
				if (node.parent != null){
					$("#currentNodeDistance").html(roundToSF(node.rate * (node.parent.height - node.height)));
				}else {
					$("#currentNodeDistance").html("NA");
				}




			}

			function unhover(){
				$("path.node").attr("fill", SPECIES_TREE_BG_COL);
				$("circle.node").removeClass("selected");
				$(".node").attr("opacity", "1");
				$(".genebranch").removeClass("selected");
				$(".currentNodeInfo").html("");

				
			}




						
			window.onkeyup = function(e) {


				if ($("textarea").is(':focus') || $("input").is(':focus')) return;

				var key = e.keyCode ? e.keyCode : e.which;

				if (key == 39) { // Right arrow
					if (e.ctrlKey) nextTree(true); // Ctrl + right = last tree
					else nextTree();
				
				
				}
				
				else if (key == 37) { // Left arrow
					if (e.ctrlKey) prevTree(true); // Ctrl + left = first tree
					else prevTree();
				
				}
				
				else if (key == 27){ // Escape
					closeDialogs();
				}


			   
			}





			function loadFileAsString(url, resolve = function(result) { }){
			    
				console.log("Trying to open", url);
				var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});
						var str = xhttp.responseText;
						resolve(str);

					}
				}
				xhttp.open("GET", url, true);
			    	xhttp.send();

			}



		
			// Loads a .csv file and returns as an object
			function loadCSV(url, resolve = function(result) { }){
			    
			    console.log("Trying to open", url);
			    var xhttp = new XMLHttpRequest();
			    xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
				  
				    if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});

				    //console.log("xhttp.responseText", xhttp.responseText);
				    var csvString = xhttp.responseText.split("\n");
						if (csvString.length == 0)  return resolve( {error: "Error: empty csv file detected at " + url} );
						
						
						var CSV_obj = {};
						var column_names = [];
						
						
						// Parse the file
						var haveParsedHeader = false;
						var nrows = 0;
						for (var i = 0; i < csvString.length; i ++){
							var line = csvString[i].trim();
							if (line == "") continue;
							
							var splitLine = line.split("\t");
							
							
							
							
							var rowIsHeader = false;
							for (var j = 0; j < splitLine.length; j ++){
							
								// Parse the header
								if (!haveParsedHeader){
									rowIsHeader = true;
									
									column_names.push(splitLine[j]);
									CSV_obj[splitLine[j]] = [];
									
									

								
								} else {
								
									var value = splitLine[j];
									var colName = column_names[j];
									if (colName == null)  return resolve( {error: "Error: too many columns in row " + i + " of file " + url} );
									
									CSV_obj[colName].push(value);
									
									
								
								}
								
							}
							
							if (rowIsHeader) haveParsedHeader = true;
							else nrows ++;
						
						
						}
				    

						CSV_obj.nrows = nrows;
						return resolve(CSV_obj);

				   
				}
			    };
			    xhttp.open("GET", url, true);
			    xhttp.send();
			    
			    
			}




			function roundToSF(val, sf=2, ceilOrFloor = "none", precise = true){
				
				var magnitude = Math.floor(log(val, 10));

				if (val < 0 && ceilOrFloor == "ceil") ceilOrFloor = "floor";
				else if (val < 0 && ceilOrFloor == "floor") ceilOrFloor = "ceil";

				var num = val * tenToThePowerOf(sf-magnitude, precise);
				if (ceilOrFloor == "ceil") num = Math.ceil(num)
				else if (ceilOrFloor == "floor") num = Math.floor(num)
				else num = Math.round(num);

				num = num * tenToThePowerOf(magnitude-sf, precise);
				
				// Sometimes this picks up a trailing .00000000001 which we want to remove

				var expectedStringLength = 0;
				if (magnitude >= 0) expectedStringLength = magnitude >= sf ? magnitude+1 : sf+2; // Add 1 for the decimal point
				else expectedStringLength = 2 -magnitude + sf;
				if (num < 0) expectedStringLength++; // Also need the negative symbol



				num = parseFloat(num.toString().substring(0, expectedStringLength+1));
				
				return num;
					
			}




			// Compute 10^n without using Math.pow for negative n which presents numerical instabilities
			function tenToThePowerOf(n, precise = true){

				if (!precise) return Math.pow(10, n);

				if (n == Infinity || n == -Infinity) return n;

				if (n == 0) return 1;
				var val = "1";
				if (n < 0) {
				
				
					for (var index = -1; index > n; index --){
						val = "0" + val;
					}
					val = "." + val;
				}

				else if (n > 0) {
					return Math.pow(10, n);

				}
				else {
					return 1;
				}
				//console.log(n, "->", parseFloat(val));
				return parseFloat(val);


			}


			function log(num, base = null){
				
				if (num == 0) return 0;
				if (base == null) return Math.log(Math.abs(num));
				return Math.log(Math.abs(num)) / Math.log(base);
				
				
			}


			// https://codepen.io/rgfx/pen/qxyGyy
			function resizable (el) {
				function resize() {el.style.width = ((el.value.length+1) * 0.5) + "em"};
				var e = 'keyup,keypress,focus,blur,change'.split(',');
				for (var i in e) el.addEventListener(e[i],resize,false);
				resize();
			}


			function resizeInput(ele){
				var int = 0.5;
				$(ele).width( (($(ele).val().length + 1) * 0.5) + "em" );
			}
			




		</script>

	</head>
	<body  onload="init()">


		<div id="modelSideNav" class="sidenav" style="width:0px;">

			<div class="sideNavHeader">
				Model settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>
			

			
			

		</div>
	
	
			
		<div id="speciesTreeSideNav" class="sidenav" style="width:0px;">

			<div class="sideNavHeader">
				Species tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>
			
			
			
			<div class="sideNavSetting">
				<input id="SUBTREE_SPACER" class="slider" onchange="setVisualParams();" type="range" min="0" max="3" value="0" step="0.05">
				Horizontal spacing (<span></span>)
			</div>

			
			<div class="sideNavSetting">
				<input id="SPECIES_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="4" value="0" step="0.05">
				Baseline branch width (<span></span> px)
			</div>

			
			<table id="speciesTreeBGColours">
				<tr id="visualSettingsRowspeciesBG" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBG" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBG");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch interior colour
					</td>
				</tr>
			</table>
			
			
			
			<table id="speciesTreeLineColours">
				<tr  id="visualSettingsRowspeciesBorder" class="sideNavSetting">
					<td style="width:2em">
					</td>
				
					<td>
						<span id="colourboxspeciesBorder" class="colourbox" title="Select colour" onclick='openColourPicker("speciesBorder");' style="background-color:white"></span>
					</td>
					
					<td>
						Branch border colour
					</td>
				</tr>
			</table>
			
			
			
			
			

		</div>
		
		
		<div id="geneTreeSideNav" class="sidenav" style="width:0px;">	
		
			<div class="sideNavHeader">
				Gene tree settings 
				<a href="javascript:void(0)" title="Close" class="closebtn" onclick="closeNav()">&times;</a>
			</div>
			
			
			<div class="sideNavSetting">
				<input id="GENE_NODE_SIZE" class="slider" onchange="setVisualParams();" type="range" min="0" max="10" value="0" step="0.05">
				Gene node radius (<span></span> px)
			</div>
			
			
			<div class="sideNavSetting">
				<input id="GENE_BRANCH_WIDTH" class="slider" onchange="setVisualParams();" type="range" min="0" max="5" value="0" step="0.05">
				Baseline branch width (<span></span> px)
			</div>
			
			
			<div class="sideNavSetting" title="Group gene tree nodes by genes or taxa">
				<div><b> Group gene trees by </b></div>
				<span style="font-size:100%; vertical-align:middle">Genes</span>	
				<label class="switch">
						 <input class="modelSetting" type="checkbox" id="GROUP_GENES_BY_TAXA" OnChange="setVisualParams();"> </input>
						 <span class="switchslider notboolean"></span>
					</label> 
				<span style="font-size:100%; vertical-align:middle">Taxa</span>	
				
			</div>
			

			
			<table id="geneTreeColours">
			
			</table>
		
			
		</div>
		
		

		<div id="innerBody">


			<div id="header">

				
			
					<ul class="flex-container thicklines" style="font-size:20%;">
				
						<li class="flex-item" style="width:30%">
						
							<div style="margin-top:5em;">
						
								<div class="textbutton left showAfterTreeUpload" onclick="uploadNewFiles()" title="Upload additional files">Open</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openDownloadDialog()" title="Download">Save As</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('modelSideNav')" title="Configure species trees settings">Model</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('speciesTreeSideNav')" title="Configure species trees settings">Species tree</div>
								<div class="textbutton left showAfterTreeUpload" onclick="openSettings('geneTreeSideNav')" title="Configure gene trees settings">Gene trees</div>
							</div>
						
						</li>
						
						<li class="flex-item" style="width:40%;  font-size:580%; line-height:120%">
							UglyTrees
							<div class="subheader">A multispecies coalescent tree visualiser </div>	
						</li>
						
						
						<li class="flex-item" style="width:30%">
							
						</li>
						

					</ul>
				
				
			</div>


			<!--
			<div class="sideTab" style="top:300px">&#9776; Species tree</div>
			
			<div class="sideTab" style="top:450px">&#9776; Gene trees</div>
			-->

			

			<div id="main">

				<table id="fileUploading" cellspacing=10>
					<tr>
						<td>
							<div id="species_tree_upload" class="uploader">
								<div>Upload a species tree file</div>
								<span id="speciesTreeUploadMsg"></span>
								
							</div>
						</td>

						<td>
							<div id="gene_tree_upload" class="uploader">
								<div>Upload one or more gene tree files</div>
								<span id="geneTreeUploadMsg"></span>
							</div>
						</td>
					</tr>
					
					<tr>
						<td style="text-align:center" colspan=2>
							<br><br><br><br>
							<span id="renderTreesBtn" onclick="userSaysDraw();" class="button large disabled">Draw trees</span>
						</td>
					</tr>
					
				</table>		

				<svg id="tree" height = 0 width = 0></svg>
			</div>

			<!--
			<div style="width:70%;  min-width:900px; margin-left:15%; margin-top:50px; text-align:center; background-color:white; border-color:#696969">

				<table style="vertical-align:top; text-align:center; width:100%; padding: 20" cellpadding=0 cellspacing=0>
					<tr>


						<td  style="width:50px"></td>

						<td  style="vertical-align:top; width:700px">
							<svg id="tree" style=" border-style:solid; border-radius:5px; border-width:0.5px;" height = 0 width = 0></svg>
						</td>


						<td style="vertical-align:bottom; width:200px">

							

							<div id="operatorPanel"></div> <br><br><br>


							<span class="button" onclick="operate()">Apply operator</span> <br><br>


							<div style="text-align:left; margin-left: 10px">
								<span title="Window size" style="padding:5"> $w$ = <input onchange="updateAlphaWindow()" type="number" min=0 step=0.0005 id="windowInput" value=0.01 style="width: 80px; padding:5; margin-bottom:5px"></span>  <br>
								<span title="Sampled alpha" style="padding:5"> $\alpha$ = <span id="sampledAlpha" style="padding:5; margin-right:20px"></span></span> <br> 
							</div> <br>
			
							
							
							
							<div style="color:white; word-break: break-all; border-radius:5px; text-align:left; font-size:120%; padding: 20; border-style:solid; background-color:#DB5079">
								<div style="text-align:center">
									<b>Selected node</b><br>
									<i class="currentNodeInfo" id="currentNodeName"></i><br>
								</div> 

								<span title="Time / height"> $t$ = <span class="currentNodeInfo" id="currentNodeTime" style="padding:5; margin-right:20px"></span></span> <br> 
								<span title="Rate of above branch"> $r$ = <span class="currentNodeInfo"  id="currentNodeRate" style="padding:5; margin-right:20px"></span></span> <br>
								<span title="Genetic distance of above branch"> $d$ = <span class="currentNodeInfo"  id="currentNodeDistance" style="padding:5; margin-right:20px"></span></span> <br>
								<span title="Effective population size of above branch"> $N$ = <span class="currentNodeInfo"  id="currentNodeSize" style="padding:5; margin-right:20px"></span></span> <br>
							</div>


						</td>

						<td  style="width:50px"></td>

					</tr>
				</table>

				<br><br><br>




			</div>
			-->

			


			<div id="footer" >


				
				<span title="Go to first tree (ctrl + &larr;)" class="arrow" onclick="prevTree(true)">&#xab;</span> 
				<span title="Go to previous tree (&larr;)" class="arrow" onclick="prevTree()">&#x2039;</span> 
				<span id="treeNumContainer">Tree number: <input class="numberinput cranberry" type="number" id="treeNum" style="width:2em; font-size:100%" onchange="setTree()"  value=0></input></span>
				<span title="Go to next tree (&rarr;)" class="arrow" onclick="nextTree()">&#x203A;</span>
				<span title="Go to last tree (ctrl + &rarr;)" class="arrow" onclick="nextTree(true)">&#xbb;</span> 


				
			</div>

		</div>

	</body>




</html>
